<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Hands on lab to understand IBM Event Streams on IBM Cloud Schema Registry feature"><meta name=author content="Jerome Boyer"><link href=https://ibm-cloud-architecture.github.com/refarch-eda/use-cases/schema-registry-on-cloud/ rel=canonical><link rel=icon href=../../assets/favicon.png><meta name=generator content="mkdocs-1.3.1, mkdocs-material-8.4.1"><title>Event Streams on IBM Cloud Schema Registry Lab - IBM Automation - Event-driven Solution - Sharing knowledge</title><link rel=stylesheet href=../../assets/stylesheets/main.69437709.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.cbb835fc.min.css><meta name=theme-color content=#000000><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#index class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="IBM Automation - Event-driven Solution - Sharing knowledge" class="md-header__button md-logo" aria-label="IBM Automation - Event-driven Solution - Sharing knowledge" data-md-component=logo> <img src=../../images/es-icon.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> IBM Automation - Event-driven Solution - Sharing knowledge </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Event Streams on IBM Cloud Schema Registry Lab </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/ibm-cloud-architecture/refarch-eda title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> ibm-cloud-architecture/refarch-eda </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="IBM Automation - Event-driven Solution - Sharing knowledge" class="md-nav__button md-logo" aria-label="IBM Automation - Event-driven Solution - Sharing knowledge" data-md-component=logo> <img src=../../images/es-icon.png alt=logo> </a> IBM Automation - Event-driven Solution - Sharing knowledge </label> <div class=md-nav__source> <a href=https://github.com/ibm-cloud-architecture/refarch-eda title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> ibm-cloud-architecture/refarch-eda </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Home </a> </li> <li class=md-nav__item> <a href=../../news/ class=md-nav__link> What's new </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Introduction <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Introduction data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Introduction </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../introduction/overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../introduction/reference-architecture/ class=md-nav__link> Reference Architecture </a> </li> <li class=md-nav__item> <a href=../../introduction/usecases/ class=md-nav__link> Business Use Cases </a> </li> <li class=md-nav__item> <a href=../../introduction/target-audiences/ class=md-nav__link> Target Audiences </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Learning Journey <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Learning Journey" data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Learning Journey </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../journey/101/ class=md-nav__link> Get started (101 content) </a> </li> <li class=md-nav__item> <a href=../../journey/201/ class=md-nav__link> Deeper dive (201 content) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5> Concepts <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Concepts data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../concepts/terms-and-definitions/ class=md-nav__link> Terms & Definitions </a> </li> <li class=md-nav__item> <a href=../../concepts/integration/ class=md-nav__link> Agile Integration </a> </li> <li class=md-nav__item> <a href=../../concepts/events-versus-messages/ class=md-nav__link> Event streaming versus Queuing </a> </li> <li class=md-nav__item> <a href=../../concepts/fit-to-purpose/ class=md-nav__link> Fit for purpose </a> </li> <li class=md-nav__item> <a href=../../concepts/model/ class=md-nav__link> Devising the data models </a> </li> <li class=md-nav__item> <a href=../../concepts/flow-architectures/ class=md-nav__link> Flow Architecture </a> </li> <li class=md-nav__item> <a href=../../concepts/service-mesh/ class=md-nav__link> Service mesh </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> Advantages of EDA <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Advantages of EDA" data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Advantages of EDA </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../advantages/microservice/ class=md-nav__link> Microservice decoupling </a> </li> <li class=md-nav__item> <a href=../../advantages/reactive/ class=md-nav__link> Reactive systems </a> </li> <li class=md-nav__item> <a href=../../advantages/resiliency/ class=md-nav__link> Resiliency </a> </li> <li class=md-nav__item> <a href=../../advantages/scalability/ class=md-nav__link> Scalability </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7> Patterns in EDA <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Patterns in EDA" data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Patterns in EDA </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../patterns/intro/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../patterns/event-sourcing/ class=md-nav__link> Event Sourcing </a> </li> <li class=md-nav__item> <a href=../../patterns/cqrs/ class=md-nav__link> CQRS </a> </li> <li class=md-nav__item> <a href=../../patterns/saga/ class=md-nav__link> Saga </a> </li> <li class=md-nav__item> <a href=../../patterns/dlq/ class=md-nav__link> Dead Letter Queue </a> </li> <li class=md-nav__item> <a href=../../patterns/topic-replication/ class=md-nav__link> Topic Replication </a> </li> <li class=md-nav__item> <a href=../../patterns/data-pipeline/ class=md-nav__link> Data Intensive App </a> </li> <li class=md-nav__item> <a href=../../patterns/realtime-analytics/ class=md-nav__link> Near real-time analytics </a> </li> <li class=md-nav__item> <a href=../../patterns/api-mgt/ class=md-nav__link> API management </a> </li> <li class=md-nav__item> <a href=../../patterns/cep/ class=md-nav__link> Situational decision </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_8 type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8> Methodology <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Methodology data-md-level=1> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Methodology </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../methodology/event-storming/ class=md-nav__link> Event Storming </a> </li> <li class=md-nav__item> <a href=../../methodology/domain-driven-design/ class=md-nav__link> Domain-Driven Design </a> </li> <li class=md-nav__item> <a href=../../methodology/data-intensive/ class=md-nav__link> Data Intensive App Development </a> </li> <li class=md-nav__item> <a href=../../methodology/data-lineage/ class=md-nav__link> Data lineage </a> </li> <li class=md-nav__item> <a href=../../methodology/governance/ class=md-nav__link> Governance </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_9 type=checkbox id=__nav_9> <label class=md-nav__link for=__nav_9> Technology <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Technology data-md-level=1> <label class=md-nav__title for=__nav_9> <span class="md-nav__icon md-icon"></span> Technology </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../technology/kafka-overview/ class=md-nav__link> Kafka Overview </a> </li> <li class=md-nav__item> <a href=../../technology/event-streams/ class=md-nav__link> Event Streams </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/eda-tech-academy/demo/ class=md-nav__link> Event Streams Demo Script </a> </li> <li class=md-nav__item> <a href=../../technology/faq/ class=md-nav__link> Kafka FAQ </a> </li> <li class=md-nav__item> <a href=../../technology/mq/ class=md-nav__link> MQ in EDA context </a> </li> <li class=md-nav__item> <a href=../../technology/kafka-producers/ class=md-nav__link> Kafka Producers </a> </li> <li class=md-nav__item> <a href=../../technology/kafka-consumers/ class=md-nav__link> Kafka Consumers </a> </li> <li class=md-nav__item> <a href=../../technology/avro-schemas/ class=md-nav__link> Avro Schema </a> </li> <li class=md-nav__item> <a href=../../technology/advanced-kafka/ class=md-nav__link> Advanced Concepts </a> </li> <li class=md-nav__item> <a href=../../technology/kafka-streams/ class=md-nav__link> Kafka Streams </a> </li> <li class=md-nav__item> <a href=../../technology/kafka-connect/ class=md-nav__link> Kafka Connect </a> </li> <li class=md-nav__item> <a href=../../technology/event-streams/es-maas/security/ class=md-nav__link> Kafka security </a> </li> <li class=md-nav__item> <a href=../../technology/kafka-monitoring/ class=md-nav__link> Kafka Monitoring </a> </li> <li class=md-nav__item> <a href=../../technology/kafka-mirrormaker/ class=md-nav__link> Mirror Maker 2 </a> </li> <li class=md-nav__item> <a href=../../technology/security/ class=md-nav__link> Security </a> </li> <li class=md-nav__item> <a href=../../technology/flink/ class=md-nav__link> Apache Flink </a> </li> <li class=md-nav__item> <a href=../../technology/spring/ class=md-nav__link> Spring cloud </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_10 type=checkbox id=__nav_10 checked> <label class=md-nav__link for=__nav_10> Use Cases <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Use Cases" data-md-level=1> <label class=md-nav__title for=__nav_10> <span class="md-nav__icon md-icon"></span> Use Cases </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../gitops/ class=md-nav__link> Event-driven solution GitOps </a> </li> <li class=md-nav__item> <a href=../../technology/event-streams/es-cp4i/ class=md-nav__link> Deploy Event-Streams </a> </li> <li class=md-nav__item> <a href=../connect-s3/ class=md-nav__link> Kafka Connect - S3 </a> </li> <li class=md-nav__item> <a href=../connect-cos/ class=md-nav__link> Kafka Connect - COS </a> </li> <li class=md-nav__item> <a href=../connect-jdbc/ class=md-nav__link> Kafka Connect - jdbc </a> </li> <li class=md-nav__item> <a href=../connect-mq/ class=md-nav__link> Kafka Connect - MQ </a> </li> <li class=md-nav__item> <a href=../connect-rabbitmq/ class=md-nav__link> Kafka Connect - Rabbitmq </a> </li> <li class=md-nav__item> <a href=../kafka-streams/ class=md-nav__link> Kafka Streams labs </a> </li> <li class=md-nav__item> <a href=../db2-debezium/ class=md-nav__link> DB2 - CDC Debezium - Outbox </a> </li> <li class=md-nav__item> <a href=../kafka-mm2/ class=md-nav__link> Mirror maker 2 labs </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Schema registry ES on Cloud <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Schema registry ES on Cloud </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#index class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=#requirements class=md-nav__link> Requirements </a> </li> <li class=md-nav__item> <a href=#ibm-event-streams-service-credentials class=md-nav__link> IBM Event Streams Service Credentials </a> </li> <li class=md-nav__item> <a href=#kafdrop class=md-nav__link> Kafdrop </a> </li> <li class=md-nav__item> <a href=#python-demo-environment class=md-nav__link> Python Demo Environment </a> <nav class=md-nav aria-label="Python Demo Environment"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#clone class=md-nav__link> Clone </a> </li> <li class=md-nav__item> <a href=#build class=md-nav__link> Build </a> </li> <li class=md-nav__item> <a href=#run class=md-nav__link> Run </a> </li> <li class=md-nav__item> <a href=#exit class=md-nav__link> Exit </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#schema-registry class=md-nav__link> Schema Registry </a> <nav class=md-nav aria-label="Schema Registry"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#overview class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=#current-features class=md-nav__link> Current features </a> </li> <li class=md-nav__item> <a href=#current-limitations class=md-nav__link> Current limitations </a> </li> <li class=md-nav__item> <a href=#enabling-the-schema-registry class=md-nav__link> Enabling the Schema Registry </a> </li> <li class=md-nav__item> <a href=#accessing-the-schema-registry class=md-nav__link> Accessing the Schema Registry </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#schemas class=md-nav__link> Schemas </a> <nav class=md-nav aria-label=Schemas> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-a-schema class=md-nav__link> Create a schema </a> </li> <li class=md-nav__item> <a href=#list-schemas class=md-nav__link> List schemas </a> </li> <li class=md-nav__item> <a href=#delete-schemas class=md-nav__link> Delete schemas </a> </li> <li class=md-nav__item> <a href=#create-new-schema-version class=md-nav__link> Create new schema version </a> </li> <li class=md-nav__item> <a href=#get-latest-version-of-a-schema class=md-nav__link> Get latest version of a schema </a> </li> <li class=md-nav__item> <a href=#get-specific-version-of-a-schema class=md-nav__link> Get specific version of a schema </a> </li> <li class=md-nav__item> <a href=#listing-all-versions-of-a-schema class=md-nav__link> Listing all versions of a schema </a> </li> <li class=md-nav__item> <a href=#deleting-a-version-of-a-schema class=md-nav__link> Deleting a version of a schema </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#python-avro-producer class=md-nav__link> Python Avro Producer </a> <nav class=md-nav aria-label="Python Avro Producer"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#produce-message class=md-nav__link> Produce Message </a> </li> <li class=md-nav__item> <a href=#avro-utils class=md-nav__link> Avro Utils </a> </li> <li class=md-nav__item> <a href=#kafka-avro-producer class=md-nav__link> Kafka Avro Producer </a> </li> <li class=md-nav__item> <a href=#run_1 class=md-nav__link> Run </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#python-avro-consumer class=md-nav__link> Python Avro Consumer </a> <nav class=md-nav aria-label="Python Avro Consumer"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#consume-message class=md-nav__link> Consume Message </a> </li> <li class=md-nav__item> <a href=#kafka-avro-consumer class=md-nav__link> Kafka Avro Consumer </a> </li> <li class=md-nav__item> <a href=#run_2 class=md-nav__link> Run </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#schemas-and-messages class=md-nav__link> Schemas and Messages </a> <nav class=md-nav aria-label="Schemas and Messages"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-a-message class=md-nav__link> Create a message </a> </li> <li class=md-nav__item> <a href=#create-a-non-compliant-message class=md-nav__link> Create a non-compliant message </a> </li> <li class=md-nav__item> <a href=#consume-a-message class=md-nav__link> Consume a message </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#data-evolution class=md-nav__link> Data Evolution </a> <nav class=md-nav aria-label="Data Evolution"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#rules class=md-nav__link> Rules </a> <nav class=md-nav aria-label=Rules> <ul class=md-nav__list> <li class=md-nav__item> <a href=#get-the-current-value-of-a-global-rule class=md-nav__link> Get the current value of a global rule </a> </li> <li class=md-nav__item> <a href=#update-a-global-rule class=md-nav__link> Update a global rule </a> </li> <li class=md-nav__item> <a href=#get-a-per-schema-rule class=md-nav__link> Get a per-schema rule </a> </li> <li class=md-nav__item> <a href=#create-a-per-schema-rule class=md-nav__link> Create a per-schema rule </a> </li> <li class=md-nav__item> <a href=#update-a-per-schema-rule class=md-nav__link> Update a per-schema rule </a> </li> <li class=md-nav__item> <a href=#delete-a-per-schema-rule class=md-nav__link> Delete a per-schema rule </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#evolve-your-schemas class=md-nav__link> Evolve your schemas </a> </li> <li class=md-nav__item> <a href=#none class=md-nav__link> None </a> </li> <li class=md-nav__item> <a href=#new-schema class=md-nav__link> New Schema </a> </li> <li class=md-nav__item> <a href=#backward class=md-nav__link> Backward </a> </li> <li class=md-nav__item> <a href=#forward class=md-nav__link> Forward </a> </li> <li class=md-nav__item> <a href=#full class=md-nav__link> Full </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#security class=md-nav__link> Security </a> <nav class=md-nav aria-label=Security> <ul class=md-nav__list> <li class=md-nav__item> <a href=#schema-security-role-mapping class=md-nav__link> Schema security role mapping </a> </li> <li class=md-nav__item> <a href=#compatibilitty-rules-security-role-mapping class=md-nav__link> Compatibilitty rules security role mapping </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../schema-registry-on-ocp/ class=md-nav__link> Schema registry </a> </li> <li class=md-nav__item> <a href=../monitoring-on-cloud/ class=md-nav__link> Monitoring ES on Cloud </a> </li> <li class=md-nav__item> <a href=../monitoring-on-ocp/ class=md-nav__link> Monitoring ES </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_11 type=checkbox id=__nav_11> <label class=md-nav__link for=__nav_11> Scenarios <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Scenarios data-md-level=1> <label class=md-nav__title for=__nav_11> <span class="md-nav__icon md-icon"></span> Scenarios </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../scenarios/overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/refarch-kc/ class=md-nav__link> Reefer Shipment Solution </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/vaccine-solution-main/ class=md-nav__link> Vaccine at Scale </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/eda-rt-inventory-gitops class=md-nav__link> Near real-time Inventory </a> </li> <li class=md-nav__item> <a href=../../scenarios/saga-orchestration/ class=md-nav__link> SAGA with MQ Orchestration </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../additional-reading/ class=md-nav__link> Additional reading </a> </li> <li class=md-nav__item> <a href=../../contribute/ class=md-nav__link> Contribute to this Site </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#index class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=#requirements class=md-nav__link> Requirements </a> </li> <li class=md-nav__item> <a href=#ibm-event-streams-service-credentials class=md-nav__link> IBM Event Streams Service Credentials </a> </li> <li class=md-nav__item> <a href=#kafdrop class=md-nav__link> Kafdrop </a> </li> <li class=md-nav__item> <a href=#python-demo-environment class=md-nav__link> Python Demo Environment </a> <nav class=md-nav aria-label="Python Demo Environment"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#clone class=md-nav__link> Clone </a> </li> <li class=md-nav__item> <a href=#build class=md-nav__link> Build </a> </li> <li class=md-nav__item> <a href=#run class=md-nav__link> Run </a> </li> <li class=md-nav__item> <a href=#exit class=md-nav__link> Exit </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#schema-registry class=md-nav__link> Schema Registry </a> <nav class=md-nav aria-label="Schema Registry"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#overview class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=#current-features class=md-nav__link> Current features </a> </li> <li class=md-nav__item> <a href=#current-limitations class=md-nav__link> Current limitations </a> </li> <li class=md-nav__item> <a href=#enabling-the-schema-registry class=md-nav__link> Enabling the Schema Registry </a> </li> <li class=md-nav__item> <a href=#accessing-the-schema-registry class=md-nav__link> Accessing the Schema Registry </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#schemas class=md-nav__link> Schemas </a> <nav class=md-nav aria-label=Schemas> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-a-schema class=md-nav__link> Create a schema </a> </li> <li class=md-nav__item> <a href=#list-schemas class=md-nav__link> List schemas </a> </li> <li class=md-nav__item> <a href=#delete-schemas class=md-nav__link> Delete schemas </a> </li> <li class=md-nav__item> <a href=#create-new-schema-version class=md-nav__link> Create new schema version </a> </li> <li class=md-nav__item> <a href=#get-latest-version-of-a-schema class=md-nav__link> Get latest version of a schema </a> </li> <li class=md-nav__item> <a href=#get-specific-version-of-a-schema class=md-nav__link> Get specific version of a schema </a> </li> <li class=md-nav__item> <a href=#listing-all-versions-of-a-schema class=md-nav__link> Listing all versions of a schema </a> </li> <li class=md-nav__item> <a href=#deleting-a-version-of-a-schema class=md-nav__link> Deleting a version of a schema </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#python-avro-producer class=md-nav__link> Python Avro Producer </a> <nav class=md-nav aria-label="Python Avro Producer"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#produce-message class=md-nav__link> Produce Message </a> </li> <li class=md-nav__item> <a href=#avro-utils class=md-nav__link> Avro Utils </a> </li> <li class=md-nav__item> <a href=#kafka-avro-producer class=md-nav__link> Kafka Avro Producer </a> </li> <li class=md-nav__item> <a href=#run_1 class=md-nav__link> Run </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#python-avro-consumer class=md-nav__link> Python Avro Consumer </a> <nav class=md-nav aria-label="Python Avro Consumer"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#consume-message class=md-nav__link> Consume Message </a> </li> <li class=md-nav__item> <a href=#kafka-avro-consumer class=md-nav__link> Kafka Avro Consumer </a> </li> <li class=md-nav__item> <a href=#run_2 class=md-nav__link> Run </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#schemas-and-messages class=md-nav__link> Schemas and Messages </a> <nav class=md-nav aria-label="Schemas and Messages"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-a-message class=md-nav__link> Create a message </a> </li> <li class=md-nav__item> <a href=#create-a-non-compliant-message class=md-nav__link> Create a non-compliant message </a> </li> <li class=md-nav__item> <a href=#consume-a-message class=md-nav__link> Consume a message </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#data-evolution class=md-nav__link> Data Evolution </a> <nav class=md-nav aria-label="Data Evolution"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#rules class=md-nav__link> Rules </a> <nav class=md-nav aria-label=Rules> <ul class=md-nav__list> <li class=md-nav__item> <a href=#get-the-current-value-of-a-global-rule class=md-nav__link> Get the current value of a global rule </a> </li> <li class=md-nav__item> <a href=#update-a-global-rule class=md-nav__link> Update a global rule </a> </li> <li class=md-nav__item> <a href=#get-a-per-schema-rule class=md-nav__link> Get a per-schema rule </a> </li> <li class=md-nav__item> <a href=#create-a-per-schema-rule class=md-nav__link> Create a per-schema rule </a> </li> <li class=md-nav__item> <a href=#update-a-per-schema-rule class=md-nav__link> Update a per-schema rule </a> </li> <li class=md-nav__item> <a href=#delete-a-per-schema-rule class=md-nav__link> Delete a per-schema rule </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#evolve-your-schemas class=md-nav__link> Evolve your schemas </a> </li> <li class=md-nav__item> <a href=#none class=md-nav__link> None </a> </li> <li class=md-nav__item> <a href=#new-schema class=md-nav__link> New Schema </a> </li> <li class=md-nav__item> <a href=#backward class=md-nav__link> Backward </a> </li> <li class=md-nav__item> <a href=#forward class=md-nav__link> Forward </a> </li> <li class=md-nav__item> <a href=#full class=md-nav__link> Full </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#security class=md-nav__link> Security </a> <nav class=md-nav aria-label=Security> <ul class=md-nav__list> <li class=md-nav__item> <a href=#schema-security-role-mapping class=md-nav__link> Schema security role mapping </a> </li> <li class=md-nav__item> <a href=#compatibilitty-rules-security-role-mapping class=md-nav__link> Compatibilitty rules security role mapping </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/ibm-cloud-architecture/refarch-eda/edit/master/docs/use-cases/schema-registry-on-cloud/index.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1>Schema registry ES on Cloud</h1> <!-- Originally available via "/technology/event-streams/schema-registry/" --> <p>This documentation aims to be a introductory hands-on lab on IBM Event Streams on IBM Cloud Schema Registry where we will go through the different capabilities of the Schema Registry that is available for IBM Event Streams on IBM Cloud users.</p> <p>We strongly recommend to complete first the <strong>IBM Event Streams on IBM Cloud lab</strong> you can find <a href=/technology/event-streams/es-cloud/ >here</a>.</p> <h2 id=index>Index<a class=headerlink href=#index title="Permanent link">&para;</a></h2> <p><anchorlinks> <anchorlink>Requirements</anchorlink> <anchorlink>IBM Event Streams Service Credentials</anchorlink> <anchorlink>Kafdrop</anchorlink> <anchorlink>Python Demo Environment</anchorlink> <anchorlink>Schema Registry</anchorlink> <anchorlink>Schemas</anchorlink> <anchorlink>Python Avro Producer</anchorlink> <anchorlink>Python Avro Consumer</anchorlink> <anchorlink>Schemas and Messages</anchorlink> <anchorlink>Data Evolution</anchorlink> <anchorlink>Security</anchorlink> </anchorlinks></p> <h2 id=requirements>Requirements<a class=headerlink href=#requirements title="Permanent link">&para;</a></h2> <p>This lab requires the following components to work against:</p> <ol> <li>An IBM Cloud account.</li> <li>An IBM Event Streams instance with the Enterprise plan (Schema Registry is only available to these instance for now) - <a href="https://cloud.ibm.com/docs/EventStreams?topic=eventstreams-getting_started">https://cloud.ibm.com/docs/EventStreams?topic=eventstreams-getting_started</a></li> </ol> <p>On your development workstation you will need:</p> <ol> <li><em>(optional)</em> IBM Cloud CLI - <a href="https://cloud.ibm.com/docs/cli?topic=cloud-cli-getting-started">https://cloud.ibm.com/docs/cli?topic=cloud-cli-getting-started</a></li> <li><em>(optional)</em> IBM CLoud CLI Event Streams plugin - <a href="https://cloud.ibm.com/docs/EventStreams?topic=eventstreams-cli#step5_es_cli">https://cloud.ibm.com/docs/EventStreams?topic=eventstreams-cli#step5_es_cli</a></li> <li>Docker - <a href=https://docs.docker.com/get-docker/ >https://docs.docker.com/get-docker/</a></li> <li>Kafdrop - <a href=https://github.com/obsidiandynamics/kafdrop>https://github.com/obsidiandynamics/kafdrop</a></li> </ol> <h2 id=ibm-event-streams-service-credentials>IBM Event Streams Service Credentials<a class=headerlink href=#ibm-event-streams-service-credentials title="Permanent link">&para;</a></h2> <p>At this point, we want to create the needed service credentials in order to allow other applications, tools, scripts to interact with our IBM Event Streams instance. For doing so, we need to:</p> <ol> <li> <p>In your IBM Event Streams instance service page, click on <em>Service credentials</em> on the left hand side menu:</p> <p><img alt=8 src=images/8.png></p> </li> <li> <p>Observe, there is no service credentials yet and click on the <em>New credential</em> button on the top right corner:</p> <p><img alt=9 src=images/9.png></p> </li> <li> <p>Enter a name for your service, choose <em>Manager</em> role for now and click on <em>Add</em>:</p> <p><img alt=10 src=images/10.png></p> </li> <li> <p>You should now see your new service credential and be able to inspect its details if you click on its dropdown arrow on it left:</p> <p><img alt=11 src=images/11.png></p> </li> <li> <p>We could have created the service credentials using the CLI as well but we leave that as extra homework for students to try on their own. However, we can explore the service credentials using the CLI with <code>ibmcloud resource service-key &lt;service_credentials_name&gt;</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>$ ibmcloud resource service-key demo-serv-cred
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>Retrieving service key demo-serv-cred <span class=k>in</span> all resource groups under account Kedar Kulkarni<span class=err>&#39;</span>s Account as ALMARAZJ@ie.ibm.com...
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>Name:          demo-serv-cred
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>ID:            crn:v1:bluemix:public:messagehub:eu-de:a/b636d1d83e34d7ae7e904591ac248cfa:b05be932-2a60-4315-951d-a6dd902e687a:resource-key:4ba348d2-5fcf-4c13-a265-360e983d99c5
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>Created At:    Tue May <span class=m>12</span> <span class=m>10</span>:53:02 UTC <span class=m>2020</span>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>State:         active
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>Credentials:
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>            api_key:                  *****
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>            apikey:                   *****
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>            iam_apikey_description:   Auto-generated <span class=k>for</span> key 4ba348d2-5fcf-4c13-a265-360e983d99c5
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>            iam_apikey_name:          demo-serv-cred
<a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>            iam_role_crn:             crn:v1:bluemix:public:iam::::serviceRole:Manager
<a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>            iam_serviceid_crn:        crn:v1:bluemix:public:iam-identity::a/b636d1d83e34d7ae7e904591ac248cfa::serviceid:ServiceId-380e866c-5914-4e01-85c4-d80bd1b8a899
<a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>            instance_id:              b05be932-2a60-4315-951d-a6dd902e687a
<a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>            kafka_admin_url:          https://mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud
<a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>            kafka_brokers_sasl:       <span class=o>[</span>kafka-2.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093 kafka-0.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093 kafka-1.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093<span class=o>]</span>
<a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>            kafka_http_url:           https://mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud
<a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>            password:                 *****
<a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>            user:                     token
</code></pre></div> </li> </ol> <p><inlinenotification kind=warning></p> <p><strong>IMPORTANT:</strong> Out of number <strong>4</strong> above, we are going to define the following important environment variables that will be used throughout this lab so please make sure you understand and define these properly</p> <p></inlinenotification></p> <ol> <li> <p><strong>KAFKA_BROKERS</strong> which should take the value of <strong>kafka_brokers_sasl</strong> comma separated:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=nb>export</span> <span class=nv>KAFKA_BROKERS</span><span class=o>=</span>kafka-2.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093,kafka-1.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093,kafka-0.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093
</code></pre></div> </li> <li> <p><strong>KAFKA_APIKEY</strong> which should take the value of <strong>apikey</strong>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=nb>export</span> <span class=nv>KAFKA_APIKEY</span><span class=o>=</span>*****
</code></pre></div> </li> <li> <p><strong>URL</strong> which should take the value of <strong>kafka_http_url</strong>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=nb>export</span> <span class=nv>URL</span><span class=o>=</span>https://mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud
</code></pre></div> </li> <li> <p><strong>SCHEMA_REGISTRY_URL</strong> which should be a combination of the three before in the form of:</p> <p><code>https://token:&lt;apikey&gt;@&lt;kafka_http_url&gt;/confluent</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=nb>export</span> <span class=nv>SCHEMA_REGISTRY_URL</span><span class=o>=</span>https://token:*****@mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud/confluent
</code></pre></div> </li> </ol> <p><inlinenotification kind=info></p> <p><strong>INFO:</strong> The reason for this "weird" schema registry url configuration is because we are using the Confluent SerDes as we will see in the <a href=#python-avro-producer>Python Avro Producer</a> and <a href=#python-avro-consumer>Python Avro Consumer</a> sections later on. Otherwise, the schema registry url would simply be the same as the <strong>kafka_http_url</strong> in your service credentials.</p> <p></inlinenotification></p> <h2 id=kafdrop>Kafdrop<a class=headerlink href=#kafdrop title="Permanent link">&para;</a></h2> <p>Kafdrop is a web UI for viewing Kafka topics and browsing consumer groups. The tool displays information such as brokers, topics, partitions, consumers, and lets you view messages: <a href=https://github.com/obsidiandynamics/kafdrop>https://github.com/obsidiandynamics/kafdrop</a></p> <p>Kafdrop runs as a Docker container in your wokstation and in order to run it,</p> <ol> <li> <p>Set the <strong>password</strong> value for the <strong>sasl.jaas.config</strong> property in the <a href=https://github.com/ibm-cloud-architecture/refarch-eda-tools/blob/master/labs/es-cloud-schema-lab/kafka.properties>kafka.properties</a> file you can find in this repo. The value for password is the <em>api_key/password</em> attributes of your service credentials. If you don't remember how to get this, review that section <a href=#api-key>here</a></p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=na>security.protocol</span><span class=o>=</span><span class=s>SASL_SSL</span><span class=w></span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=na>ssl.protocol</span><span class=o>=</span><span class=s>TLSv1.2</span><span class=w></span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=na>ssl.enabled.protocols</span><span class=o>=</span><span class=s>TLSv1.2</span><span class=w></span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=na>ssl.endpoint.identification.algorithm</span><span class=o>=</span><span class=s>HTTPS</span><span class=w></span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=na>sasl.mechanism</span><span class=o>=</span><span class=s>PLAIN</span><span class=w></span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=na>sasl.jaas.config</span><span class=o>=</span><span class=s>org.apache.kafka.common.security.plain.PlainLoginModule required username=&quot;token&quot; password=&quot;&lt;YOUR_PASSWORD/API_KEY_HERE&gt;&quot;;</span><span class=w></span>
</code></pre></div> </li> <li> <p>Run the Kafdrop Docker container by executing:</p> <p><div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>$ docker run -d --rm -p <span class=m>9000</span>:9000 <span class=se>\</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>    -e <span class=nv>KAFKA_BROKERCONNECT</span><span class=o>=</span><span class=nv>$KAFKA_BROKERS</span> <span class=se>\</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>    -e <span class=nv>KAFKA_PROPERTIES</span><span class=o>=</span><span class=k>$(</span>cat kafka.properties <span class=p>|</span> base64<span class=k>)</span> <span class=se>\</span>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>    -e <span class=nv>JVM_OPTS</span><span class=o>=</span><span class=s2>&quot;-Xms32M -Xmx64M&quot;</span> <span class=se>\</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>    -e <span class=nv>SERVER_SERVLET_CONTEXTPATH</span><span class=o>=</span><span class=s2>&quot;/&quot;</span> <span class=se>\</span>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>    obsidiandynamics/kafdrop
</code></pre></div> (*) After running the above command, you can use the docker container id returned on the screen to debug any possible issue with <code>docker logs -f &lt;container_id&gt;</code>. This container id will be used to stop the Kafdrop container once we have finished.</p> </li> <li> <p>You can point your browser to <a href=http://localhost:9000/ >http://localhost:9000/</a> to access the Kafdrop application:</p> <p><img alt=18 src=images/18.png></p> </li> <li> <p>You can see the topic details by clicking on the name of that topic:</p> <p><img alt=19 src=images/19.png></p> </li> <li> <p>You can watch the messages on this topic by clicking on <em>View Messages</em> button under the topic name and configuring the partition, offset and number of messages option that you are presented with in the next screen. Finally, click on <em>View Messages</em> button at the right:</p> <p><img alt=20 src=images/20.png></p> </li> <li> <p>To stop the Kafdrop container once you have finsihed the tutorial, simply list the containers running on your workstation, find the container id for your Kafdrop container and stop it:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>$ docker ps
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>CONTAINER ID        IMAGE                                       COMMAND             CREATED             STATUS              PORTS                    NAMES
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>ba6c8eaf6a3a        ibmcase/python-schema-registry-lab:latest   <span class=s2>&quot;bash&quot;</span>              <span class=m>31</span> seconds ago      Up <span class=m>30</span> seconds                                keen_neumann
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>bab9cae43f15        obsidiandynamics/kafdrop                    <span class=s2>&quot;/kafdrop.sh&quot;</span>       <span class=m>17</span> minutes ago      Up <span class=m>17</span> minutes       <span class=m>0</span>.0.0.0:9000-&gt;9000/tcp   laughing_dirac
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>$ docker stop bab9cae43f15
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>bab9cae43f15
</code></pre></div> </li> </ol> <h2 id=python-demo-environment>Python Demo Environment<a class=headerlink href=#python-demo-environment title="Permanent link">&para;</a></h2> <p>Given that students' workstations may vary quite a lot, not only on their operating system but also on the tools installed on them and the tools we need for our lab might install differently, we have opted to provide a python demo environment in the form of a Docker container where all the libraries and tools needed are already pre-installed.</p> <h3 id=clone>Clone<a class=headerlink href=#clone title="Permanent link">&para;</a></h3> <p>In order to build our python demo environment we first need to clone the github repository where the assets live. This github repository is <a href=https://github.com/ibm-cloud-architecture/refarch-eda-tools>https://github.com/ibm-cloud-architecture/refarch-eda-tools</a> and the specific assets we refer to can be found under the <code>labs/es-cloud-schema-lab</code> folder:</p> <ol> <li> <p>Clone the github repository on your workstation on the location of your choice:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>$ git clone https://github.com/ibm-cloud-architecture/refarch-eda-tools.git
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>Cloning into <span class=s1>&#39;refarch-eda-tools&#39;</span>...
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>remote: Enumerating objects: <span class=m>185</span>, <span class=k>done</span>.
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>remote: Counting objects: <span class=m>100</span>% <span class=o>(</span><span class=m>185</span>/185<span class=o>)</span>, <span class=k>done</span>.
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>remote: Compressing objects: <span class=m>100</span>% <span class=o>(</span><span class=m>148</span>/148<span class=o>)</span>, <span class=k>done</span>.
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>remote: Total <span class=m>185</span> <span class=o>(</span>delta <span class=m>23</span><span class=o>)</span>, reused <span class=m>176</span> <span class=o>(</span>delta <span class=m>16</span><span class=o>)</span>, pack-reused <span class=m>0</span>
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>Receiving objects: <span class=m>100</span>% <span class=o>(</span><span class=m>185</span>/185<span class=o>)</span>, <span class=m>6</span>.17 MiB <span class=p>|</span> <span class=m>4</span>.61 MiB/s, <span class=k>done</span>.
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>Resolving deltas: <span class=m>100</span>% <span class=o>(</span><span class=m>23</span>/23<span class=o>)</span>, <span class=k>done</span>.
</code></pre></div> </li> <li> <p>Change directory into <code>refarch-eda-tools/labs/es-cloud-schema-lab</code> to find the assets we will we working from now on for the python demo environment and few other scripts/applications:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>$ <span class=nb>cd</span> refarch-eda-tools/labs/es-cloud-schema-lab
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>$ ls -all
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>total <span class=m>240</span>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>drwxr-xr-x   <span class=m>9</span> user  staff     <span class=m>288</span> <span class=m>20</span> May <span class=m>19</span>:33 .
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>drwxr-xr-x   <span class=m>3</span> user  staff      <span class=m>96</span> <span class=m>20</span> May <span class=m>19</span>:33 ..
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>-rw-r--r--   <span class=m>1</span> user  staff    <span class=m>1012</span> <span class=m>20</span> May <span class=m>19</span>:33 Dockerfile
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>-rw-r--r--   <span class=m>1</span> user  staff  <span class=m>112578</span> <span class=m>20</span> May <span class=m>19</span>:33 README.md
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>drwxr-xr-x   <span class=m>5</span> user  staff     <span class=m>160</span> <span class=m>20</span> May <span class=m>19</span>:33 avro_files
<a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a>drwxr-xr-x  <span class=m>27</span> user  staff     <span class=m>864</span> <span class=m>20</span> May <span class=m>19</span>:33 images
<a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a>drwxr-xr-x   <span class=m>6</span> user  staff     <span class=m>192</span> <span class=m>20</span> May <span class=m>19</span>:33 kafka
<a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a>-rw-r--r--   <span class=m>1</span> user  staff     <span class=m>286</span> <span class=m>20</span> May <span class=m>19</span>:33 kafka.properties
<a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a>drwxr-xr-x   <span class=m>6</span> user  staff     <span class=m>192</span> <span class=m>20</span> May <span class=m>19</span>:33 src
</code></pre></div> </li> </ol> <h3 id=build>Build<a class=headerlink href=#build title="Permanent link">&para;</a></h3> <p>This Docker container can be built by using the <a href=https://github.com/ibm-cloud-architecture/refarch-eda-tools/blob/master/labs/es-cloud-schema-lab/Dockerfile>Dockerfile</a> provided within this github repository.</p> <p>To build your python demo environment Docker container, execute the following on your workstation:</p> <p><div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>docker build -t <span class=s2>&quot;ibmcase/python-schema-registry-lab:latest&quot;</span> .
</code></pre></div> <inlinenotification kind=warning></p> <p><strong>WARNING:</strong></p> <ul> <li>Mind the <strong>dot</strong> at the end of the command.</li> <li>Be consistent throughout the lab with the name you give to the Docker container.</li> </ul> <p></inlinenotification></p> <h3 id=run>Run<a class=headerlink href=#run title="Permanent link">&para;</a></h3> <p>In order to run the python demo environment Docker container, execute the following on your workstation:</p> <ol> <li> <p>Make sure you have declared your <code>KAFKA_BROKERS</code>, <code>KAFKA_APIKEY</code> and <code>SCHEMA_REGISTRY_URL</code> environment variables as explain in the <a href=#ibm-event-streams-service-credentials>IBM Event Streams Service Credentials</a> section.</p> </li> <li> <p>Run the python demo environment container</p> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a>$ docker run -e <span class=nv>KAFKA_BROKERS</span><span class=o>=</span><span class=nv>$KAFKA_BROKERS</span> <span class=se>\</span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>             -e <span class=nv>KAFKA_APIKEY</span><span class=o>=</span><span class=nv>$KAFKA_APIKEY</span> <span class=se>\</span>
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>             -e <span class=nv>SCHEMA_REGISTRY_URL</span><span class=o>=</span><span class=nv>$SCHEMA_REGISTRY_URL</span> <span class=se>\</span>
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>             -v <span class=si>${</span><span class=nv>PWD</span><span class=si>}</span>:/tmp/lab <span class=se>\</span>
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>             --rm <span class=se>\</span>
<a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>             -ti ibmcase/python-schema-registry-lab:latest bash
</code></pre></div> </li> <li> <p>Go to <code>/tmp/lab</code> to find all the assets you will need to complete this lab.</p> </li> </ol> <p><inlinenotification kind=info></p> <p><strong>INFO:</strong> we have mounted this working directory into the container so any changes to any of the files apply within the container. This is good as we do not need to restart the python demo environment Docker container if we want to do any changes to the files.</p> <p></inlinenotification></p> <h3 id=exit>Exit<a class=headerlink href=#exit title="Permanent link">&para;</a></h3> <p>Once you are done with the python demo environment container, just execute <code>exit</code> and you will get out of the container and the container will automatically be removed from your system.</p> <h2 id=schema-registry>Schema Registry<a class=headerlink href=#schema-registry title="Permanent link">&para;</a></h2> <p><inlinenotification kind=info></p> <p><strong>INFO:</strong> The following documentation about the IBM Event Streams on IBM Cloud Schema registry until the end of this lab is based on the Schema Registry status as of mid May 2020 when this tutorial was developed</p> <p></inlinenotification></p> <p><img alt=diagram src=images/EDA-avro-schema-registry.png></p> <p>One of the most common technologies used in the industry these days to define, serialize and deserialize messages flowing through your Kafka topics is Apache Avro (<a href=https://avro.apache.org/docs/current/ >https://avro.apache.org/docs/current/</a>). To learn more about Apache Avro, how to define Apache Avro data schemas and more see our documentation <a href=https://ibm-cloud-architecture.github.io/refarch-kc/avro/avro>here</a></p> <p>IBM Event Streams on IBM Cloud development team has developed a Schema Registry to work along your Kafka cluster to provide centralized schema management and compatibility checks as schemas evolve so that the communication between Kafka producers and consumers follow these schemas for consistency or as many like to say, meet the contracts that schemas are.</p> <h3 id=overview>Overview<a class=headerlink href=#overview title="Permanent link">&para;</a></h3> <p>The schema registry capability is being developed for the IBM Event Streams managed Kafka service running in IBM Cloud. The purpose of the schema registry is to provide a place to store descriptions of the message formats used by your producers and consumers. The benefit of storing these descriptions is that you are able to validate that your producing and consuming applications will correctly inter-operate.</p> <p>Currently the schema registry is in early access status. This means that a limited function version of the registry is being made available to a small group of users for the purpose of gathering feedback, and rapidly iterating on the design of the registry. Please note that while the schema registry is in early access, there may be occasions when IBM will delete all of the schema data held within the registry.</p> <h3 id=current-features>Current features<a class=headerlink href=#current-features title="Permanent link">&para;</a></h3> <ul> <li>Support for creating, listing and deleting schemas via a REST interface</li> <li>Support for creating, listing and deleting versions of a schema, via a REST interface</li> <li>Support for using schema information in Kafka producer and consumer applications via the Confluent AVRO SerDes</li> <li>Support for Apache AVRO as the format used to express schemas</li> <li>Support for applying constraints on schema compatibility, either at a global scope, or on a per-schema basis</li> <li>Access to schema registry requires authentication and access is controlled via IAM</li> <li>Access to individual schemas, and compatibility rules can be controlled via a new IAM schema resource type</li> <li>Constraints on maximum schema size (64K), the maximum number of schemas that can be stored in the registry (1000) and the maximum number of versions a schema can have (100)</li> <li>SLA of 99.99% availability, consistent with that of the Event Streams service</li> </ul> <h3 id=current-limitations>Current limitations<a class=headerlink href=#current-limitations title="Permanent link">&para;</a></h3> <ul> <li>No caching performed for frequently requested schemas</li> <li>Does not publish metrics to Sysdig</li> <li>Does not generate Activity Tracker events</li> <li>There may be other missing functions that you require. Please let IBM know!</li> </ul> <h3 id=enabling-the-schema-registry>Enabling the Schema Registry<a class=headerlink href=#enabling-the-schema-registry title="Permanent link">&para;</a></h3> <p>Currently the schema registry is not enabled by default and can only be enabled for IBM Event Streams Enterprise plan service instances. To request the enablement of the schema registry, please raise a support ticket <a href="https://cloud.ibm.com/docs/get-support?topic=get-support-getting-customer-support#using-avatar">here</a>. Ensure that you <strong>include the CRN of your Event Streams service instance in the ticket</strong>. The CRN of the service instance can be found using the following IBM Cloud CLI command <code>ibmcloud resource service-instance &lt;SERVICENAME&gt;</code> (where <code>SERVICENAME</code> is the name of your Event Streams service instance). For more info on how to get your IBM Event Streams service instance CRN review the <a href=/technology/event-streams/es-cloud/#creating-event-streams-instance-with-ibm-cloud-cli>Event Streams on Cloud hands on lab</a>.</p> <p>If you have already enabled the schema registry capability for an Event Streams Enterprise plan service instance, it will automatically receive updates as new capabilities become available.</p> <h3 id=accessing-the-schema-registry>Accessing the Schema Registry<a class=headerlink href=#accessing-the-schema-registry title="Permanent link">&para;</a></h3> <p>To access the schema registry, you will need the URL of the schema registry as well as a set of credentials that can be used to authenticate with the registry. Both of these pieces of information can be found by inspecting the service credentials for your service. To view these in the UI, click on your service instance, select <em>Service credentials</em> in the left-hand navigation pane, then click on the dropdown arrow next to one of the service credentials name listed in the table. You should see something like this:</p> <p><img alt=22 src=images/22.png></p> <p>You will need the value of <strong>kafka_http_url</strong>, which is also the URL of the schema registry, and the value of <strong>apikey</strong> which you can use as the credential for authenticating with the schema registry.</p> <p>To check we have appropriate permissions to work with the Schema Registry, we can execute the following command that would actually list the schemas stored in the schema registry in our terminal:</p> <p><code>curl -i u token:&lt;KAFKA_APIKEY&gt; &lt;URL&gt;/artifacts</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>curl -i -u token:***** https://mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud/artifacts
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>HTTP/1.1 <span class=m>200</span> OK
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>Date: Wed, <span class=m>13</span> May <span class=m>2020</span> <span class=m>11</span>:38:36 GMT
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>Content-Type: application/json
<a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>Content-Length: <span class=m>3</span>
<a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a>Connection: keep-alive
<a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a>
<a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=o>[]</span>
</code></pre></div> <p>As you can see, no schema is being retrieved which makes sense with the just out of the box schema registry status we are at.</p> <p><inlinenotification kind=info></p> <p><strong>INFO:</strong> For easiness executing the following schema registry REST API commands, we recommend you set your <strong>kafka_http_url</strong> and <strong>apikey</strong> as <strong>URL</strong> and <strong>KAFKA_APIKEY</strong> environment variables respectively as explained in the <a href=#ibm-event-streams-service-credentials>IBM Event Streams Service Credentials</a> section.</p> <p></inlinenotification></p> <h2 id=schemas>Schemas<a class=headerlink href=#schemas title="Permanent link">&para;</a></h2> <p>In this section we will finally get our hands dirty with the IBM Event Steams on IBM Cloud Schema Registry capability by working with Apache Avro schemas and the schema registry.</p> <h3 id=create-a-schema>Create a schema<a class=headerlink href=#create-a-schema title="Permanent link">&para;</a></h3> <p>This endpoint is used to store a schema in the registry. The schema data is sent as the body of the post request. An ID for the schema can be included using the <code>X-Registry-ArtifactId</code> request header. If this header is not present in the request, then an ID will be generated. The content type header must be set to <code>application/json</code>.</p> <p>Creating a schema requires at least both:</p> <ul> <li>Reader role access to the Event Streams cluster resource type</li> <li> <p>Writer role access to the schema resource that matches the schema being created</p> </li> <li> <p>Create a schema with:</p> <p><code>curl -u token:$KAFKA_APIKEY -H 'Content-Type: application/json' -H 'X- Registry-ArtifactId: &lt;SCHEMA_ID&gt;' $URL/artifacts -d '&lt;AVRO_SCHEMA&gt;'</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>$ curl  -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=se>\</span>
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>        -H <span class=s1>&#39;Content-Type: application/json&#39;</span> <span class=se>\</span>
<a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>        -H <span class=s1>&#39;X-Registry-ArtifactId: demo-schema&#39;</span> <span class=se>\</span>
<a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a>        <span class=nv>$URL</span>/artifacts <span class=se>\</span>
<a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a>        -d <span class=s1>&#39;{   &quot;type&quot;:&quot;record&quot;,</span>
<a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=s1>                &quot;name&quot;:&quot;demoSchema&quot;,</span>
<a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=s1>                &quot;fields&quot;:[</span>
<a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=s1>                        {&quot;name&quot;: &quot;eventKey&quot;,&quot;type&quot;:&quot;string&quot;},</span>
<a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=s1>                        {&quot;name&quot;: &quot;message&quot;,&quot;type&quot;:&quot;string&quot;}] }&#39;</span>
<a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a>
<a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=o>{</span><span class=s2>&quot;id&quot;</span>:<span class=s2>&quot;demo-schema&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;AVRO&quot;</span>,<span class=s2>&quot;version&quot;</span>:1,<span class=s2>&quot;createdBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;createdOn&quot;</span>:1589371190273,<span class=s2>&quot;modifiedBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;modifiedOn&quot;</span>:1589371190273,<span class=s2>&quot;globalId&quot;</span>:1<span class=o>}</span>
</code></pre></div> </li> <li> <p>Create a few more schemas.</p> </li> </ul> <h3 id=list-schemas>List schemas<a class=headerlink href=#list-schemas title="Permanent link">&para;</a></h3> <p>Listing schemas requires at least:</p> <ul> <li> <p>Reader role access to the Event Streams cluster resource type</p> </li> <li> <p>List the schemas and see the ones you have created previously with:</p> <p><code>curl -u token:$KAFKA_APIKEY $URL/artifacts</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/artifacts
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=o>[</span><span class=s2>&quot;demo-schema&quot;</span>,<span class=s2>&quot;demo-schema-2&quot;</span><span class=o>]</span>
</code></pre></div> </li> </ul> <h3 id=delete-schemas>Delete schemas<a class=headerlink href=#delete-schemas title="Permanent link">&para;</a></h3> <p>Schemas are deleted from the registry by issuing a DELETE request to the <code>/artifacts/{schema-id}</code> endpoint (where <code>{schema-id}</code> is the ID of the schema). If successful an empty response, and a status code of 204 (no content) is returned.</p> <p>Deleting a schema requires at least both:</p> <ul> <li>Reader role access to the Event Streams cluster resource type</li> <li> <p>Manager role access to the schema resource that matches the schema being deleted</p> </li> <li> <p>Delete one (or all) of the schemas you created previously with:</p> <p><code>curl -u token:$KAFKA_APIKEY -X DELETE $URL/artifacts/my-schema</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a>$ curl -i -u token:<span class=nv>$KAFKA_APIKEY</span> -X DELETE <span class=nv>$URL</span>/artifacts/demo-schema
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>HTTP/1.1 <span class=m>204</span> No Content
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>Date: Wed, <span class=m>13</span> May <span class=m>2020</span> <span class=m>12</span>:37:48 GMT
<a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>Connection: keep-alive
</code></pre></div> </li> </ul> <h3 id=create-new-schema-version>Create new schema version<a class=headerlink href=#create-new-schema-version title="Permanent link">&para;</a></h3> <p>To create a new version of a schema, make a POST request to the <code>/artifacts/{schema-id}/versions</code> endpoint, (where <code>{schema-id}</code> is the ID of the schema). The body of the request must contain the new version of the schema.</p> <p>If the request is successful the new schema version is created as the new latest version of the schema, with an appropriate version number, and a response with status code 200 (OK) and a payload containing metadata describing the new version, (including the version number), is returned.</p> <p>Creating a new version of a schema requires at least both:</p> <ul> <li>Reader role access to the Event Streams cluster resource type</li> <li> <p>Writer role access to the schema resource that matches the schema getting a new version</p> </li> <li> <p>Create a new schema:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a>$ curl  -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=se>\</span>
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a>        -H <span class=s1>&#39;Content-Type: application/json&#39;</span> <span class=se>\</span>
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>        -H <span class=s1>&#39;X-Registry-ArtifactId: version-demo-schema&#39;</span> <span class=se>\</span>
<a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a>        <span class=nv>$URL</span>/artifacts <span class=se>\</span>
<a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a>        -d <span class=s1>&#39;{&quot;type&quot;:&quot;record&quot;,</span>
<a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=s1>            &quot;name&quot;:&quot;versionDemoSchema&quot;,</span>
<a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=s1>            &quot;fields&quot;:[</span>
<a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=s1>                {&quot;name&quot;: &quot;eventKey&quot;,&quot;type&quot;:&quot;string&quot;},</span>
<a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=s1>                {&quot;name&quot;: &quot;message&quot;,&quot;type&quot;:&quot;string&quot;}] }&#39;</span>
<a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a>
<a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=o>{</span><span class=s2>&quot;id&quot;</span>:<span class=s2>&quot;version-demo-schema&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;AVRO&quot;</span>,<span class=s2>&quot;version&quot;</span>:1,<span class=s2>&quot;createdBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;createdOn&quot;</span>:1589380529049,<span class=s2>&quot;modifiedBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;modifiedOn&quot;</span>:1589380529049,<span class=s2>&quot;globalId&quot;</span>:9<span class=o>}</span>
</code></pre></div> </li> <li> <p>Add a new attribute to the schema and create a new version for it with:</p> <p><code>curl -u token:$KAFKA_APIKEY -H 'Content-Type: application/json' $URL/artifacts/&lt;SCHEMA_ID&gt;/versions -d '&lt;AVRO_SCHEMA'</code></p> <p><div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a>$ curl  -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=se>\</span>
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>        -H <span class=s1>&#39;Content-Type: application/json&#39;</span> <span class=se>\</span>
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>        -H <span class=s1>&#39;X-Registry-ArtifactId: version-demo-schema&#39;</span> <span class=se>\</span>
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a>        <span class=nv>$URL</span>/artifacts/version-demo-schema/versions <span class=se>\</span>
<a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a>        -d <span class=s1>&#39;{&quot;type&quot;:&quot;record&quot;,</span>
<a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=s1>            &quot;name&quot;:&quot;versionDemoSchema&quot;,</span>
<a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=s1>            &quot;fields&quot;:[</span>
<a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=s1>                {&quot;name&quot;: &quot;eventKey&quot;,&quot;type&quot;:&quot;string&quot;},</span>
<a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=s1>                {&quot;name&quot;: &quot;message&quot;,&quot;type&quot;:&quot;string&quot;},</span>
<a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a><span class=s1>                {&quot;name&quot;: &quot;attribute1&quot;,&quot;type&quot;:&quot;string&quot;}]}&#39;</span>
<a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a>
<a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a><span class=o>{</span><span class=s2>&quot;id&quot;</span>:<span class=s2>&quot;version-demo-schema&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;AVRO&quot;</span>,<span class=s2>&quot;version&quot;</span>:2,<span class=s2>&quot;createdBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;createdOn&quot;</span>:1589380529049,<span class=s2>&quot;modifiedBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;modifiedOn&quot;</span>:1589380728324,<span class=s2>&quot;globalId&quot;</span>:10<span class=o>}</span>
</code></pre></div> (*) See that the returned JSON object includes the version for the schema and that this has increased</p> </li> <li> <p>Create yet another new attribute and version for the schema:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a>$ curl  -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=se>\</span>
<a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>        -H <span class=s1>&#39;Content-Type: application/json&#39;</span> <span class=se>\</span>
<a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>        -H <span class=s1>&#39;X-Registry-ArtifactId: version-demo-schema&#39;</span> <span class=se>\</span>
<a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a>        <span class=nv>$URL</span>/artifacts/version-demo-schema/versions <span class=se>\</span>
<a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a>        -d <span class=s1>&#39;{&quot;type&quot;:&quot;record&quot;,</span>
<a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=s1>            &quot;name&quot;:&quot;versionDemoSchema&quot;,</span>
<a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=s1>            &quot;fields&quot;:[</span>
<a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=s1>                {&quot;name&quot;: &quot;eventKey&quot;,&quot;type&quot;:&quot;string&quot;},</span>
<a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=s1>                {&quot;name&quot;: &quot;message&quot;,&quot;type&quot;:&quot;string&quot;},</span>
<a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=s1>                {&quot;name&quot;: &quot;attribute1&quot;,&quot;type&quot;:&quot;string&quot;},</span>
<a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a><span class=s1>                {&quot;name&quot;: &quot;attribute2&quot;,&quot;type&quot;:&quot;string&quot;}]}&#39;</span>
<a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a>
<a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a><span class=o>{</span><span class=s2>&quot;id&quot;</span>:<span class=s2>&quot;version-demo-schema&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;AVRO&quot;</span>,<span class=s2>&quot;version&quot;</span>:3,<span class=s2>&quot;createdBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;createdOn&quot;</span>:1589380529049,<span class=s2>&quot;modifiedBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;modifiedOn&quot;</span>:1589380955324,<span class=s2>&quot;globalId&quot;</span>:11<span class=o>}</span>
</code></pre></div> </li> </ul> <h3 id=get-latest-version-of-a-schema>Get latest version of a schema<a class=headerlink href=#get-latest-version-of-a-schema title="Permanent link">&para;</a></h3> <p>To retrieve the latest version of a particular schema, make a GET request to the <code>/artifacts/{schema-id}</code> endpoint, (where <code>{schema-id}</code> is the ID of the schema). If successful, the latest version of the schema is returned in the payload of the response.</p> <p>Getting the latest version of a schema requires at least both:</p> <ul> <li>Reader role access to the Event Streams cluster resource type</li> <li> <p>Reader role access to the schema resource that matches the schema being retrieved</p> </li> <li> <p>Get the latest version of the schema with:</p> <p><code>curl -u token:$KAFKA_APIKEY $URL/artifacts/&lt;SCHEMA_ID&gt;</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/artifacts/version-demo-schema
<a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=o>{</span>
<a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a>    <span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;record&quot;</span>,
<a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a>    <span class=s2>&quot;name&quot;</span>:<span class=s2>&quot;versionDemoSchema&quot;</span>,
<a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a>    <span class=s2>&quot;fields&quot;</span>:<span class=o>[</span>
<a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a>        <span class=o>{</span><span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;eventKey&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;string&quot;</span><span class=o>}</span>,
<a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a>        <span class=o>{</span><span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;message&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;string&quot;</span><span class=o>}</span>,
<a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a>        <span class=o>{</span><span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;attribute1&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;string&quot;</span><span class=o>}</span>,
<a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a>        <span class=o>{</span><span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;attribute2&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;string&quot;</span><span class=o>}]</span>
<a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=o>}</span>
</code></pre></div> </li> </ul> <h3 id=get-specific-version-of-a-schema>Get specific version of a schema<a class=headerlink href=#get-specific-version-of-a-schema title="Permanent link">&para;</a></h3> <p>To retrieve a specific version of a schema, make a GET request to the <code>/artifacts/{schema-id}/versions/{version}</code> endpoint, (where <code>{schema-id}</code> is the ID of the schema, and <code>{version}</code> is the version number of the specific version you need to retrieve). If successful, the specified version of the schema is returned in the payload of the response.</p> <p>Getting the latest version of a schema requires at least both:</p> <ul> <li>Reader role access to the Event Streams cluster resource type</li> <li> <p>Reader role access to the schema resource that matches the schema being retrieved</p> </li> <li> <p>Get a specific version of a schema with:</p> <p><code>curl -u token:$KAFKA_APIKEY $URL/artifacts/&lt;SCHEMA_ID&gt;/versions/&lt;VERSION_ID&gt;</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/artifacts/version-demo-schema/versions/2
<a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=o>{</span>
<a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a>    <span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;record&quot;</span>,
<a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a>    <span class=s2>&quot;name&quot;</span>:<span class=s2>&quot;versionDemoSchema&quot;</span>,
<a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a>    <span class=s2>&quot;fields&quot;</span>:<span class=o>[</span>
<a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a>        <span class=o>{</span><span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;eventKey&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;string&quot;</span><span class=o>}</span>,
<a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a>        <span class=o>{</span><span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;message&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;string&quot;</span><span class=o>}</span>,
<a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a>        <span class=o>{</span><span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;attribute1&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;string&quot;</span><span class=o>}]</span>
<a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a><span class=o>}</span>
</code></pre></div> </li> </ul> <h3 id=listing-all-versions-of-a-schema>Listing all versions of a schema<a class=headerlink href=#listing-all-versions-of-a-schema title="Permanent link">&para;</a></h3> <p>To list all versions of a schema currently stored in the registry, make a GET request to the <code>/artifacts/{schema-id}/versions</code> endpoint, (where <code>{schema-id}</code> is the ID of the schema). If successful, a list of all current version numbers for the schema is returned in the payload of the response.</p> <p>Getting the list of available versions of a schema requires at least both:</p> <ul> <li>Reader role access to the Event Streams cluster resource type</li> <li> <p>Reader role access to the schema resource that matches the schema being retrieved</p> </li> <li> <p>Get all the versions for a schema with:</p> <p><code>curl -u token:$KAFKA_APIKEY $URL/artifacts/&lt;SCHEMA_ID&gt;/versions</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/artifacts/version-demo-schema/versions
<a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>
<a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=o>[</span><span class=m>1</span>,2,3<span class=o>]</span>
</code></pre></div> </li> </ul> <h3 id=deleting-a-version-of-a-schema>Deleting a version of a schema<a class=headerlink href=#deleting-a-version-of-a-schema title="Permanent link">&para;</a></h3> <p>Schema versions are deleted from the registry by issuing a DELETE request to the <code>/artifacts/{schema-id}/versions/{version}</code> endpoint (where <code>{schema-id}</code> is the ID of the schema, and {version} is the version number of the schema version). If successful an empty response, and a status code of 204 (no content) is returned. Deleting the only remaining version of a schema will also delete the schema.</p> <p>Deleting a schema version requires at least both:</p> <ul> <li>Reader role access to the Event Streams cluster resource type</li> <li> <p>Manager role access to the schema resource that matches the schema being deleted</p> </li> <li> <p>Delete a version of a schema with:</p> <p><code>curl -u token:$KAFKA_APIKEY -X DELETE $URL/artifacts/&lt;SCHEMA_ID&gt;/versions/&lt;VERSION_ID&gt;</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> -X DELETE <span class=nv>$URL</span>/artifacts/version-demo-schema/versions/2
</code></pre></div> </li> <li> <p>Make sure your specific version has been deleted by listing all the version for that schema:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/artifacts/version-demo-schema/versions
<a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a>
<a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=o>[</span><span class=m>1</span>,3<span class=o>]</span>
</code></pre></div> </li> </ul> <p>If you deleted a schema, it will get deleted along with all its versions.</p> <h2 id=python-avro-producer>Python Avro Producer<a class=headerlink href=#python-avro-producer title="Permanent link">&para;</a></h2> <p>In this section we describe the python scripts we will be using in order to be able to produce <strong>avro</strong> messages to a Kafka topic.</p> <h3 id=produce-message>Produce Message<a class=headerlink href=#produce-message title="Permanent link">&para;</a></h3> <p>The python script that we will use to send an avro message to a Kafka topic is <a href=https://github.com/ibm-cloud-architecture/refarch-eda-tools/tree/master/labs/es-cloud-schema-lab/src/ProduceAvroMessage.py>ProduceAvroMessage.py</a> where we have the following:</p> <ol> <li> <p>A function to parse the arguments:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=k>def</span> <span class=nf>parseArguments</span><span class=p>():</span>
<a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a>    <span class=k>global</span> <span class=n>TOPIC_NAME</span>
<a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;The arguments for this script are: &quot;</span> <span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>))</span>
<a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
<a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a>        <span class=n>TOPIC_NAME</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
<a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a>    <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;[ERROR] - The produceAvroMessage.py script expects one argument: The Kafka topic to publish the message to&quot;</span><span class=p>)</span>
<a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a>        <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</code></pre></div> </li> <li> <p>A function to create the event to be sent:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=k>def</span> <span class=nf>createEvent</span><span class=p>():</span>
<a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Creating event...&#39;</span><span class=p>)</span>
<a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a>
<a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a>    <span class=n>event</span> <span class=o>=</span> <span class=p>{</span>
<a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a>            <span class=s2>&quot;eventKey&quot;</span> <span class=p>:</span> <span class=s2>&quot;1&quot;</span><span class=p>,</span>
<a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a>            <span class=s2>&quot;message&quot;</span> <span class=p>:</span> <span class=s2>&quot;This is a test message&quot;</span>
<a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a>            <span class=p>}</span>
<a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a>
<a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;DONE&quot;</span><span class=p>)</span>
<a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a>    <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</code></pre></div> </li> <li> <p>The main where we will:</p> <ol> <li>Parse the arguments</li> <li>Get the Avro schemas for the key and value of the event</li> <li>Create the Event to be sent</li> <li>Print it out for reference</li> <li>Create the Kafka Avro Producer and configure it</li> <li>Send the event</li> </ol> <div class=highlight><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
<a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a>    <span class=c1># Get the Kafka topic name</span>
<a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a>    <span class=n>parseArguments</span><span class=p>()</span>
<a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a>    <span class=c1># Get the avro schemas for the message&#39;s key and value</span>
<a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a>    <span class=n>event_value_schema</span> <span class=o>=</span> <span class=n>getDefaultEventValueSchema</span><span class=p>(</span><span class=n>DATA_SCHEMAS</span><span class=p>)</span>
<a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a>    <span class=n>event_key_schema</span> <span class=o>=</span> <span class=n>getDefaultEventKeySchema</span><span class=p>(</span><span class=n>DATA_SCHEMAS</span><span class=p>)</span>
<a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a>    <span class=c1># Create the event</span>
<a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a>    <span class=n>message_event</span> <span class=o>=</span> <span class=n>createEvent</span><span class=p>()</span>
<a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a>    <span class=c1># Print out the event to be sent</span>
<a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;--- Container event to be published: ---&quot;</span><span class=p>)</span>
<a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a>    <span class=nb>print</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>message_event</span><span class=p>))</span>
<a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;----------------------------------------&quot;</span><span class=p>)</span>
<a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a>    <span class=c1># Create the Kafka Avro Producer</span>
<a id=__codelineno-26-14 name=__codelineno-26-14 href=#__codelineno-26-14></a>    <span class=n>kafka_producer</span> <span class=o>=</span> <span class=n>KafkaProducer</span><span class=p>(</span><span class=n>KAFKA_BROKERS</span><span class=p>,</span><span class=n>KAFKA_APIKEY</span><span class=p>,</span><span class=n>SCHEMA_REGISTRY_URL</span><span class=p>)</span>
<a id=__codelineno-26-15 name=__codelineno-26-15 href=#__codelineno-26-15></a>    <span class=c1># Prepare the Kafka Avro Producer</span>
<a id=__codelineno-26-16 name=__codelineno-26-16 href=#__codelineno-26-16></a>    <span class=n>kafka_producer</span><span class=o>.</span><span class=n>prepareProducer</span><span class=p>(</span><span class=s2>&quot;ProduceAvroMessagePython&quot;</span><span class=p>,</span><span class=n>event_key_schema</span><span class=p>,</span><span class=n>event_value_schema</span><span class=p>)</span>
<a id=__codelineno-26-17 name=__codelineno-26-17 href=#__codelineno-26-17></a>    <span class=c1># Publish the event</span>
<a id=__codelineno-26-18 name=__codelineno-26-18 href=#__codelineno-26-18></a>    <span class=n>kafka_producer</span><span class=o>.</span><span class=n>publishEvent</span><span class=p>(</span><span class=n>TOPIC_NAME</span><span class=p>,</span><span class=n>message_event</span><span class=p>,</span><span class=s2>&quot;eventKey&quot;</span><span class=p>)</span>
</code></pre></div> </li> </ol> <p>As you can see, this python code depends on a Kafka Avro Producer and an Avro Utils for loading the Avro schemas which are explained next.</p> <h3 id=avro-utils>Avro Utils<a class=headerlink href=#avro-utils title="Permanent link">&para;</a></h3> <p>This script, called <a href=https://github.com/ibm-cloud-architecture/refarch-eda-tools/tree/master/labs/es-cloud-schema-lab/avro_files/utils/avroEDAUtils.py>avroEDAUtils.py</a>, contains some very simple utility functions to be able to load Avro schemas from their <strong>avsc</strong> files in order to be used by the Kafka Avro Producer.</p> <ol> <li> <p>A function to get the key and value Avro schemas for the messages to be sent:</p> <p><div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=k>def</span> <span class=nf>getDefaultEventValueSchema</span><span class=p>(</span><span class=n>schema_files_location</span><span class=p>):</span>
<a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=c1># Get the default event value data schema</span>
<a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=n>known_schemas</span> <span class=o>=</span> <span class=n>avro</span><span class=o>.</span><span class=n>schema</span><span class=o>.</span><span class=n>Names</span><span class=p>()</span>
<a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=n>default_event_value_schema</span> <span class=o>=</span> <span class=n>LoadAvsc</span><span class=p>(</span><span class=n>schema_files_location</span> <span class=o>+</span> <span class=s2>&quot;/default_value.avsc&quot;</span><span class=p>,</span> <span class=n>known_schemas</span><span class=p>)</span>
<a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=k>return</span> <span class=n>default_event_value_schema</span>
<a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a>
<a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=k>def</span> <span class=nf>getDefaultEventKeySchema</span><span class=p>(</span><span class=n>schema_files_location</span><span class=p>):</span>
<a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=c1># Get the default event key data schema</span>
<a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=n>known_schemas</span> <span class=o>=</span> <span class=n>avro</span><span class=o>.</span><span class=n>schema</span><span class=o>.</span><span class=n>Names</span><span class=p>()</span>
<a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=n>default_event_key_schema</span> <span class=o>=</span> <span class=n>LoadAvsc</span><span class=p>(</span><span class=n>schema_files_location</span> <span class=o>+</span> <span class=s2>&quot;/default_key.avsc&quot;</span><span class=p>,</span> <span class=n>known_schemas</span><span class=p>)</span>
<a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=k>return</span> <span class=n>default_event_key_schema</span>
</code></pre></div> (*) Where <code>known_schemas</code> is an Avro schema dictionary where all Avro schemas read get stored in order to be able to read nested Avro schemas afterwards. See the python script in detail for examples of this.</p> </li> <li> <p>A function to open a file, read its content as an Avro schema and store it in the Avro schema dictionary:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=k>def</span> <span class=nf>LoadAvsc</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=n>names</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=c1># Load avsc file</span>
<a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=c1># file_path: path to schema file</span>
<a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=c1># names(optional): avro.schema.Names object</span>
<a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=n>file_text</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
<a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=n>json_data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>file_text</span><span class=p>)</span>
<a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a><span class=n>schema</span> <span class=o>=</span> <span class=n>avro</span><span class=o>.</span><span class=n>schema</span><span class=o>.</span><span class=n>SchemaFromJSONData</span><span class=p>(</span><span class=n>json_data</span><span class=p>,</span> <span class=n>names</span><span class=p>)</span>
<a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=k>return</span> <span class=n>schema</span>
</code></pre></div> </li> </ol> <h3 id=kafka-avro-producer>Kafka Avro Producer<a class=headerlink href=#kafka-avro-producer title="Permanent link">&para;</a></h3> <p>This script, called <a href=https://github.com/ibm-cloud-architecture/refarch-eda-tools/tree/master/labs/es-cloud-schema-lab/kafka/KcAvroProducer.py>KcAvroProducer.py</a>, will actually be the responsible for creating the Kafka Avro Producer, initialize and configure it and provide the publish method:</p> <ol> <li> <p>Initialize and prepare the Kafka Producer</p> <div class=highlight><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=k>class</span> <span class=nc>KafkaProducer</span><span class=p>:</span>
<a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a>
<a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>kafka_brokers</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span><span class=p>,</span><span class=n>kafka_apikey</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span><span class=p>,</span><span class=n>schema_registry_url</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span><span class=p>):</span>
<a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a>        <span class=bp>self</span><span class=o>.</span><span class=n>kafka_brokers</span> <span class=o>=</span> <span class=n>kafka_brokers</span>
<a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a>        <span class=bp>self</span><span class=o>.</span><span class=n>kafka_apikey</span> <span class=o>=</span> <span class=n>kafka_apikey</span>
<a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a>        <span class=bp>self</span><span class=o>.</span><span class=n>schema_registry_url</span> <span class=o>=</span> <span class=n>schema_registry_url</span>
<a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a>
<a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a>    <span class=k>def</span> <span class=nf>prepareProducer</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>groupID</span> <span class=o>=</span> <span class=s2>&quot;pythonproducers&quot;</span><span class=p>,</span><span class=n>key_schema</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span><span class=p>,</span> <span class=n>value_schema</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span><span class=p>):</span>
<a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a>        <span class=n>options</span> <span class=o>=</span><span class=p>{</span>
<a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a>                <span class=s1>&#39;bootstrap.servers&#39;</span><span class=p>:</span>  <span class=bp>self</span><span class=o>.</span><span class=n>kafka_brokers</span><span class=p>,</span>
<a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a>                <span class=s1>&#39;schema.registry.url&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>schema_registry_url</span><span class=p>,</span>
<a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a>                <span class=s1>&#39;group.id&#39;</span><span class=p>:</span> <span class=n>groupID</span><span class=p>,</span>
<a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a>                <span class=s1>&#39;security.protocol&#39;</span><span class=p>:</span> <span class=s1>&#39;SASL_SSL&#39;</span><span class=p>,</span>
<a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a>                <span class=s1>&#39;sasl.mechanisms&#39;</span><span class=p>:</span> <span class=s1>&#39;PLAIN&#39;</span><span class=p>,</span>
<a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a>                <span class=s1>&#39;sasl.username&#39;</span><span class=p>:</span> <span class=s1>&#39;token&#39;</span><span class=p>,</span>
<a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a>                <span class=s1>&#39;sasl.password&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>kafka_apikey</span>
<a id=__codelineno-29-17 name=__codelineno-29-17 href=#__codelineno-29-17></a>        <span class=p>}</span>
<a id=__codelineno-29-18 name=__codelineno-29-18 href=#__codelineno-29-18></a>        <span class=c1># Print out the configuration</span>
<a id=__codelineno-29-19 name=__codelineno-29-19 href=#__codelineno-29-19></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;--- This is the configuration for the producer: ---&quot;</span><span class=p>)</span>
<a id=__codelineno-29-20 name=__codelineno-29-20 href=#__codelineno-29-20></a>        <span class=nb>print</span><span class=p>(</span><span class=n>options</span><span class=p>)</span>
<a id=__codelineno-29-21 name=__codelineno-29-21 href=#__codelineno-29-21></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;---------------------------------------------------&quot;</span><span class=p>)</span>
<a id=__codelineno-29-22 name=__codelineno-29-22 href=#__codelineno-29-22></a>        <span class=c1># Create the Avro Producer</span>
<a id=__codelineno-29-23 name=__codelineno-29-23 href=#__codelineno-29-23></a>        <span class=bp>self</span><span class=o>.</span><span class=n>producer</span> <span class=o>=</span> <span class=n>AvroProducer</span><span class=p>(</span><span class=n>options</span><span class=p>,</span><span class=n>default_key_schema</span><span class=o>=</span><span class=n>key_schema</span><span class=p>,</span><span class=n>default_value_schema</span><span class=o>=</span><span class=n>value_schema</span><span class=p>)</span>
</code></pre></div> </li> <li> <p>Publish method</p> <div class=highlight><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=k>def</span> <span class=nf>publishEvent</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>topicName</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
<a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a>        <span class=c1># Produce the Avro message</span>
<a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a>        <span class=c1># Important: value DOES NOT come in JSON format from ContainerAvroProducer.py. Therefore, we must convert it to JSON format first</span>
<a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a>        <span class=bp>self</span><span class=o>.</span><span class=n>producer</span><span class=o>.</span><span class=n>produce</span><span class=p>(</span><span class=n>topic</span><span class=o>=</span><span class=n>topicName</span><span class=p>,</span><span class=n>value</span><span class=o>=</span><span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>value</span><span class=p>),</span><span class=n>key</span><span class=o>=</span><span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>value</span><span class=p>)[</span><span class=n>key</span><span class=p>],</span> <span class=n>callback</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>delivery_report</span><span class=p>)</span>
<a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a>        <span class=c1># Flush</span>
<a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a>        <span class=bp>self</span><span class=o>.</span><span class=n>producer</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>
</code></pre></div> </li> </ol> <h3 id=run_1>Run<a class=headerlink href=#run_1 title="Permanent link">&para;</a></h3> <p>We will see in the following section <a href=#schemas-and-messages>Schemas and Messages</a> how to send Avro messages according with their schemas to IBM Event Streams.</p> <h2 id=python-avro-consumer>Python Avro Consumer<a class=headerlink href=#python-avro-consumer title="Permanent link">&para;</a></h2> <p>In this section we describe the python scripts we will be using in order to be able to consume Avro messages from a Kafka topic.</p> <h3 id=consume-message>Consume Message<a class=headerlink href=#consume-message title="Permanent link">&para;</a></h3> <p>The python script that we will use to consume an Avro message from a Kafka topic is <a href=https://github.com/ibm-cloud-architecture/refarch-eda-tools/tree/master/labs/es-cloud-schema-lab/src/ConsumeAvroMessage.py>ConsumeAvroMessage.py</a> where we have the following:</p> <ol> <li> <p>A function to parse arguments:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=c1># Parse arguments to get the container ID to poll for</span>
<a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=k>def</span> <span class=nf>parseArguments</span><span class=p>():</span>
<a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a>    <span class=k>global</span> <span class=n>TOPIC_NAME</span>
<a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;The arguments for the script are: &quot;</span> <span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>))</span>
<a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>:</span>
<a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;[ERROR] - The ConsumeAvroMessage.py script expects one arguments: The Kafka topic to events from.&quot;</span><span class=p>)</span>
<a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a>        <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a>    <span class=n>TOPIC_NAME</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</code></pre></div> </li> <li> <p>The main where we will:</p> <ol> <li>Parse the arguments to get the topic to read from</li> <li>Create the Kafka Consumer and configure it</li> <li>Poll for next avro message</li> <li>Close the Kafka consumer</li> </ol> <div class=highlight><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
<a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a>    <span class=c1># Parse arguments</span>
<a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a>    <span class=n>parseArguments</span><span class=p>()</span>
<a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a>    <span class=c1># Create the Kafka Avro consumer</span>
<a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a>    <span class=n>kafka_consumer</span> <span class=o>=</span> <span class=n>KafkaConsumer</span><span class=p>(</span><span class=n>KAFKA_BROKERS</span><span class=p>,</span><span class=n>KAFKA_APIKEY</span><span class=p>,</span><span class=n>TOPIC_NAME</span><span class=p>,</span><span class=n>SCHEMA_REGISTRY_URL</span><span class=p>)</span>
<a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a>    <span class=c1># Prepare the consumer</span>
<a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a>    <span class=n>kafka_consumer</span><span class=o>.</span><span class=n>prepareConsumer</span><span class=p>()</span>
<a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a>    <span class=c1># Consume next Avro event</span>
<a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a>    <span class=n>kafka_consumer</span><span class=o>.</span><span class=n>pollNextEvent</span><span class=p>()</span>
<a id=__codelineno-32-10 name=__codelineno-32-10 href=#__codelineno-32-10></a>    <span class=c1># Close the Avro consumer</span>
<a id=__codelineno-32-11 name=__codelineno-32-11 href=#__codelineno-32-11></a>    <span class=n>kafka_consumer</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</code></pre></div> </li> </ol> <p>As you can see, this python code depends on a Kafka Consumer which is explained next.</p> <h3 id=kafka-avro-consumer>Kafka Avro Consumer<a class=headerlink href=#kafka-avro-consumer title="Permanent link">&para;</a></h3> <p>This script, called <a href=https://github.com/ibm-cloud-architecture/refarch-eda-tools/tree/master/labs/es-cloud-schema-lab/kafka/KcAvroConsumer.py>KcAvroConsumer.py</a>, will actually be the responsible for creating the Kafka Avro Consumer, initialize and configure it and provide the poll next event method:</p> <ol> <li> <p>Initialize and prepare the new Kafka consumer:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=k>class</span> <span class=nc>KafkaConsumer</span><span class=p>:</span>
<a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a>
<a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>kafka_brokers</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span><span class=p>,</span> <span class=n>kafka_apikey</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span><span class=p>,</span> <span class=n>topic_name</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span><span class=p>,</span> <span class=n>schema_registry_url</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span><span class=p>,</span> <span class=n>autocommit</span> <span class=o>=</span> <span class=kc>True</span><span class=p>):</span>
<a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a>        <span class=bp>self</span><span class=o>.</span><span class=n>kafka_brokers</span> <span class=o>=</span> <span class=n>kafka_brokers</span>
<a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a>        <span class=bp>self</span><span class=o>.</span><span class=n>kafka_apikey</span> <span class=o>=</span> <span class=n>kafka_apikey</span>
<a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a>        <span class=bp>self</span><span class=o>.</span><span class=n>topic_name</span> <span class=o>=</span> <span class=n>topic_name</span>
<a id=__codelineno-33-7 name=__codelineno-33-7 href=#__codelineno-33-7></a>        <span class=bp>self</span><span class=o>.</span><span class=n>schema_registry_url</span> <span class=o>=</span> <span class=n>schema_registry_url</span>
<a id=__codelineno-33-8 name=__codelineno-33-8 href=#__codelineno-33-8></a>        <span class=bp>self</span><span class=o>.</span><span class=n>kafka_auto_commit</span> <span class=o>=</span> <span class=n>autocommit</span>
<a id=__codelineno-33-9 name=__codelineno-33-9 href=#__codelineno-33-9></a>
<a id=__codelineno-33-10 name=__codelineno-33-10 href=#__codelineno-33-10></a>    <span class=c1># See https://github.com/edenhill/librdkafka/blob/master/CONFIGURATION.md</span>
<a id=__codelineno-33-11 name=__codelineno-33-11 href=#__codelineno-33-11></a>    <span class=k>def</span> <span class=nf>prepareConsumer</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>groupID</span> <span class=o>=</span> <span class=s2>&quot;pythonconsumers&quot;</span><span class=p>):</span>
<a id=__codelineno-33-12 name=__codelineno-33-12 href=#__codelineno-33-12></a>        <span class=n>options</span> <span class=o>=</span><span class=p>{</span>
<a id=__codelineno-33-13 name=__codelineno-33-13 href=#__codelineno-33-13></a>                <span class=s1>&#39;bootstrap.servers&#39;</span><span class=p>:</span>  <span class=bp>self</span><span class=o>.</span><span class=n>kafka_brokers</span><span class=p>,</span>
<a id=__codelineno-33-14 name=__codelineno-33-14 href=#__codelineno-33-14></a>                <span class=s1>&#39;group.id&#39;</span><span class=p>:</span> <span class=n>groupID</span><span class=p>,</span>
<a id=__codelineno-33-15 name=__codelineno-33-15 href=#__codelineno-33-15></a>                <span class=s1>&#39;auto.offset.reset&#39;</span><span class=p>:</span> <span class=s1>&#39;earliest&#39;</span><span class=p>,</span>
<a id=__codelineno-33-16 name=__codelineno-33-16 href=#__codelineno-33-16></a>                <span class=s1>&#39;schema.registry.url&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>schema_registry_url</span><span class=p>,</span>
<a id=__codelineno-33-17 name=__codelineno-33-17 href=#__codelineno-33-17></a>                <span class=s1>&#39;enable.auto.commit&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>kafka_auto_commit</span><span class=p>,</span>
<a id=__codelineno-33-18 name=__codelineno-33-18 href=#__codelineno-33-18></a>                <span class=s1>&#39;security.protocol&#39;</span><span class=p>:</span> <span class=s1>&#39;SASL_SSL&#39;</span><span class=p>,</span>
<a id=__codelineno-33-19 name=__codelineno-33-19 href=#__codelineno-33-19></a>                <span class=s1>&#39;sasl.mechanisms&#39;</span><span class=p>:</span> <span class=s1>&#39;PLAIN&#39;</span><span class=p>,</span>
<a id=__codelineno-33-20 name=__codelineno-33-20 href=#__codelineno-33-20></a>                <span class=s1>&#39;sasl.username&#39;</span><span class=p>:</span> <span class=s1>&#39;token&#39;</span><span class=p>,</span>
<a id=__codelineno-33-21 name=__codelineno-33-21 href=#__codelineno-33-21></a>                <span class=s1>&#39;sasl.password&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>kafka_apikey</span>
<a id=__codelineno-33-22 name=__codelineno-33-22 href=#__codelineno-33-22></a>        <span class=p>}</span>
<a id=__codelineno-33-23 name=__codelineno-33-23 href=#__codelineno-33-23></a>        <span class=c1># Print the configuration</span>
<a id=__codelineno-33-24 name=__codelineno-33-24 href=#__codelineno-33-24></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;--- This is the configuration for the Avro consumer: ---&quot;</span><span class=p>)</span>
<a id=__codelineno-33-25 name=__codelineno-33-25 href=#__codelineno-33-25></a>        <span class=nb>print</span><span class=p>(</span><span class=n>options</span><span class=p>)</span>
<a id=__codelineno-33-26 name=__codelineno-33-26 href=#__codelineno-33-26></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;---------------------------------------------------&quot;</span><span class=p>)</span>
<a id=__codelineno-33-27 name=__codelineno-33-27 href=#__codelineno-33-27></a>        <span class=c1># Create the Avro consumer</span>
<a id=__codelineno-33-28 name=__codelineno-33-28 href=#__codelineno-33-28></a>        <span class=bp>self</span><span class=o>.</span><span class=n>consumer</span> <span class=o>=</span> <span class=n>AvroConsumer</span><span class=p>(</span><span class=n>options</span><span class=p>)</span>
<a id=__codelineno-33-29 name=__codelineno-33-29 href=#__codelineno-33-29></a>        <span class=c1># Subscribe to the topic</span>
<a id=__codelineno-33-30 name=__codelineno-33-30 href=#__codelineno-33-30></a>        <span class=bp>self</span><span class=o>.</span><span class=n>consumer</span><span class=o>.</span><span class=n>subscribe</span><span class=p>([</span><span class=bp>self</span><span class=o>.</span><span class=n>topic_name</span><span class=p>])</span>
</code></pre></div> </li> <li> <p>Poll next event method:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=c1># Prints out the message</span>
<a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=k>def</span> <span class=nf>traceResponse</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>msg</span><span class=p>):</span>
<a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;@@@ pollNextOrder - </span><span class=si>{}</span><span class=s1> partition: [</span><span class=si>{}</span><span class=s1>] at offset </span><span class=si>{}</span><span class=s1> with key </span><span class=si>{}</span><span class=s1>:</span><span class=se>\n\t</span><span class=s1>value: </span><span class=si>{}</span><span class=s1>&#39;</span>
<a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a>                <span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>topic</span><span class=p>(),</span> <span class=n>msg</span><span class=o>.</span><span class=n>partition</span><span class=p>(),</span> <span class=n>msg</span><span class=o>.</span><span class=n>offset</span><span class=p>(),</span> <span class=n>msg</span><span class=o>.</span><span class=n>key</span><span class=p>(),</span> <span class=n>msg</span><span class=o>.</span><span class=n>value</span><span class=p>()</span> <span class=p>))</span>
<a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a>
<a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a><span class=c1># Polls for next event</span>
<a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a><span class=k>def</span> <span class=nf>pollNextEvent</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a>    <span class=c1># Poll for messages</span>
<a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a>    <span class=n>msg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>consumer</span><span class=o>.</span><span class=n>poll</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>10.0</span><span class=p>)</span>
<a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a>    <span class=c1># Validate the returned message</span>
<a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a>    <span class=k>if</span> <span class=n>msg</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;[INFO] - No new messages on the topic&quot;</span><span class=p>)</span>
<a id=__codelineno-34-13 name=__codelineno-34-13 href=#__codelineno-34-13></a>    <span class=k>elif</span> <span class=n>msg</span><span class=o>.</span><span class=n>error</span><span class=p>():</span>
<a id=__codelineno-34-14 name=__codelineno-34-14 href=#__codelineno-34-14></a>        <span class=k>if</span> <span class=p>(</span><span class=s2>&quot;PARTITION_EOF&quot;</span> <span class=ow>in</span> <span class=n>msg</span><span class=o>.</span><span class=n>error</span><span class=p>()):</span>
<a id=__codelineno-34-15 name=__codelineno-34-15 href=#__codelineno-34-15></a>            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;[INFO] - End of partition&quot;</span><span class=p>)</span>
<a id=__codelineno-34-16 name=__codelineno-34-16 href=#__codelineno-34-16></a>        <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-34-17 name=__codelineno-34-17 href=#__codelineno-34-17></a>            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;[ERROR] - Consumer error: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>error</span><span class=p>()))</span>
<a id=__codelineno-34-18 name=__codelineno-34-18 href=#__codelineno-34-18></a>    <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-34-19 name=__codelineno-34-19 href=#__codelineno-34-19></a>        <span class=c1># Print the message</span>
<a id=__codelineno-34-20 name=__codelineno-34-20 href=#__codelineno-34-20></a>        <span class=n>msgStr</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>traceResponse</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
</code></pre></div> </li> </ol> <h3 id=run_2>Run<a class=headerlink href=#run_2 title="Permanent link">&para;</a></h3> <p>We will see in the following section <a href=#schemas-and-messages>Schemas and Messages</a> how to consume Avro messages.</p> <h2 id=schemas-and-messages>Schemas and Messages<a class=headerlink href=#schemas-and-messages title="Permanent link">&para;</a></h2> <p>In this section we are going to see how Schema Registry works when you have an application that produces and consumes messages based on Avro data schemas. The application we are going to use for this is the python scripts presented above in the <a href=#python-avro-producer>Python Avro Producer</a> and <a href=#python-avro-consumer>Python Avro Consumer</a>.</p> <p>Once again, we are going to run these scripts in the python demo environment we presented earlier in this lab in <a href=#python-demo-environment>this section</a>. Please, review that section in order to understand how to run the environment in your local workstation.</p> <ol> <li> <p>Make sure you have a newly created topic for this exercise (review the <a href=/technology/event-streams/es-cloud/ >IBM Event Streams on IBM Cloud lab</a> if needed):</p> <div class=highlight><pre><span></span><code><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a>$ ibmcloud es topic-create <span class=nb>test</span>
<a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a>Created topic <span class=nb>test</span>
<a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a>OK
<a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a>
<a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a>$ ibmcloud es topics
<a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a>Topic name
<a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=nb>test</span>
<a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a>OK
</code></pre></div> </li> <li> <p>Make sure you dont have any schema registered (preferably for clarity):</p> <div class=highlight><pre><span></span><code><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/artifacts
<a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=o>[]</span>
</code></pre></div> </li> <li> <p>Start your python environment with:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a>$ docker run -e <span class=nv>KAFKA_BROKERS</span><span class=o>=</span><span class=nv>$KAFKA_BROKERS</span> <span class=se>\</span>
<a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a>             -e <span class=nv>KAFKA_APIKEY</span><span class=o>=</span><span class=nv>$KAFKA_APIKEY</span> <span class=se>\</span>
<a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a>             -e <span class=nv>SCHEMA_REGISTRY_URL</span><span class=o>=</span><span class=nv>$SCHEMA_REGISTRY_URL</span> <span class=se>\</span>
<a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a>             -v <span class=si>${</span><span class=nv>PWD</span><span class=si>}</span>:/tmp/lab <span class=se>\</span>
<a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a>             --rm <span class=se>\</span>
<a id=__codelineno-37-6 name=__codelineno-37-6 href=#__codelineno-37-6></a>             -ti ibmcase/python-schema-registry-lab:latest bash
</code></pre></div> </li> </ol> <h3 id=create-a-message>Create a message<a class=headerlink href=#create-a-message title="Permanent link">&para;</a></h3> <p>In order to create a message, we execute the <code>ProduceAvroMessage.py</code> within the <code>/tmp/lab/src</code> folder in our python demo environment. This script, as you could see in the <a href=#python-avro-producer>Python Avro Producer</a> section, it is sending the event <code>{'eventKey': '1', 'message': 'This is a test message'}</code> according to the schemas defined in <a href=https://github.com/ibm-cloud-architecture/refarch-eda-tools/blob/master/labs/es-cloud-schema-lab/avro_files/default_key.avsc>default_key.avsc</a> and <a href=https://github.com/ibm-cloud-architecture/refarch-eda-tools/blob/master/labs/es-cloud-schema-lab/avro_files/default_value.avsc>default_value.avsc</a> for the key and value of the event respectively.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a>python ProduceAvroMessage.py <span class=nb>test</span>
<a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a> @@@ Executing script: ProduceAvroMessage.py
<a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a>The arguments <span class=k>for</span> the script are:  <span class=o>[</span><span class=s1>&#39;ProduceAvroMessage.py&#39;</span>, <span class=s1>&#39;test&#39;</span><span class=o>]</span>
<a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a>Creating event...
<a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a>DONE
<a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a>--- Container event to be published: ---
<a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a><span class=o>{</span><span class=s1>&#39;eventKey&#39;</span>: <span class=s1>&#39;1&#39;</span>, <span class=s1>&#39;message&#39;</span>: <span class=s1>&#39;This is a test message&#39;</span><span class=o>}</span>
<a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a>----------------------------------------
<a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a>--- This is the configuration <span class=k>for</span> the avro producer: ---
<a id=__codelineno-38-10 name=__codelineno-38-10 href=#__codelineno-38-10></a><span class=o>{</span><span class=s1>&#39;bootstrap.servers&#39;</span>: <span class=s1>&#39;kafka-2.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093,kafka-1.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093,kafka-0.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093&#39;</span>, <span class=s1>&#39;schema.registry.url&#39;</span>: <span class=s1>&#39;https://token:4uk9gZ-n85a2esMoMZ5wtW-yIq_29o3PrHVBEFBj67N0@mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud/confluent&#39;</span>, <span class=s1>&#39;group.id&#39;</span>: <span class=s1>&#39;ProduceAvroMessagePython&#39;</span>, <span class=s1>&#39;security.protocol&#39;</span>: <span class=s1>&#39;SASL_SSL&#39;</span>, <span class=s1>&#39;sasl.mechanisms&#39;</span>: <span class=s1>&#39;PLAIN&#39;</span>, <span class=s1>&#39;sasl.username&#39;</span>: <span class=s1>&#39;token&#39;</span>, <span class=s1>&#39;sasl.password&#39;</span>: <span class=s1>&#39;*****&#39;</span><span class=o>}</span>
<a id=__codelineno-38-11 name=__codelineno-38-11 href=#__codelineno-38-11></a>---------------------------------------------------
<a id=__codelineno-38-12 name=__codelineno-38-12 href=#__codelineno-38-12></a>Message delivered to <span class=nb>test</span> <span class=o>[</span><span class=m>0</span><span class=o>]</span>
</code></pre></div> <p>We should now have a new message in our <code>test</code> kafka topic. We can check that out using <a href=#kafdrop>Kafdrop</a>:</p> <p><img alt=23 src=images/23.png></p> <p><inlinenotification kind=info></p> <p><strong>INFO:</strong> Mind the message now is not in JSON format as Avro does not repeat every field name with every single record which makes Avro more efficient than JSON for high-volume usage. This is thanks to having Avro schemas.</p> <p></inlinenotification></p> <p><inlinenotification kind=warning></p> <p><strong>WARNING:</strong> Most of the Avro producer clients, whether it is in Java, Python or many other languages, give users the ability to <strong>auto-register</strong> a schema automatically with the specified schema registry in its configuration.</p> <p></inlinenotification></p> <p>If we look know at the schemas our schema registry has:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/artifacts
<a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a>
<a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a><span class=o>[</span><span class=s2>&quot;test-key&quot;</span>,<span class=s2>&quot;test-value&quot;</span><span class=o>]</span>
</code></pre></div> <p>we see two schemas, <code>test-key</code> and <code>test-value</code>, which in fact correspond to the Avro data schema used for the <code>key</code> (<a href=https://github.com/ibm-cloud-architecture/refarch-eda-tools/blob/master/labs/es-cloud-schema-lab/avro_files/default_key.avsc>default_key.avsc</a>) and the <code>value</code> (<a href=https://github.com/ibm-cloud-architecture/refarch-eda-tools/blob/master/labs/es-cloud-schema-lab/avro_files/default_value.avsc>default_value.avsc</a>) of events sent to the <code>test</code> topic in the <a href=https://github.com/ibm-cloud-architecture/refarch-eda-tools/tree/master/labs/es-cloud-schema-lab/src/ProduceAvroMessage.py>ProduceAvroMessage.py</a> as explained before sending the message.</p> <p>To make sure of what we are saying, we can inspect those schemas:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/artifacts/test-key
<a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a>
<a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a><span class=s2>&quot;string&quot;</span>
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a>$ curl -s -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/artifacts/test-value <span class=p>|</span> jq .
<a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=o>{</span>
<a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a>  <span class=s2>&quot;type&quot;</span>: <span class=s2>&quot;record&quot;</span>,
<a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a>  <span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;defaultValue&quot;</span>,
<a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a>  <span class=s2>&quot;namespace&quot;</span>: <span class=s2>&quot;ibm.eda.default&quot;</span>,
<a id=__codelineno-41-6 name=__codelineno-41-6 href=#__codelineno-41-6></a>  <span class=s2>&quot;fields&quot;</span>: <span class=o>[</span>
<a id=__codelineno-41-7 name=__codelineno-41-7 href=#__codelineno-41-7></a>    <span class=o>{</span>
<a id=__codelineno-41-8 name=__codelineno-41-8 href=#__codelineno-41-8></a>      <span class=s2>&quot;type&quot;</span>: <span class=s2>&quot;string&quot;</span>,
<a id=__codelineno-41-9 name=__codelineno-41-9 href=#__codelineno-41-9></a>      <span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;eventKey&quot;</span>,
<a id=__codelineno-41-10 name=__codelineno-41-10 href=#__codelineno-41-10></a>      <span class=s2>&quot;doc&quot;</span>: <span class=s2>&quot;We expect any string as the event key&quot;</span>
<a id=__codelineno-41-11 name=__codelineno-41-11 href=#__codelineno-41-11></a>    <span class=o>}</span>,
<a id=__codelineno-41-12 name=__codelineno-41-12 href=#__codelineno-41-12></a>    <span class=o>{</span>
<a id=__codelineno-41-13 name=__codelineno-41-13 href=#__codelineno-41-13></a>      <span class=s2>&quot;type&quot;</span>: <span class=s2>&quot;string&quot;</span>,
<a id=__codelineno-41-14 name=__codelineno-41-14 href=#__codelineno-41-14></a>      <span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;message&quot;</span>,
<a id=__codelineno-41-15 name=__codelineno-41-15 href=#__codelineno-41-15></a>      <span class=s2>&quot;doc&quot;</span>: <span class=s2>&quot;Any string message&quot;</span>
<a id=__codelineno-41-16 name=__codelineno-41-16 href=#__codelineno-41-16></a>    <span class=o>}</span>
<a id=__codelineno-41-17 name=__codelineno-41-17 href=#__codelineno-41-17></a>  <span class=o>]</span>,
<a id=__codelineno-41-18 name=__codelineno-41-18 href=#__codelineno-41-18></a>  <span class=s2>&quot;doc&quot;</span>: <span class=s2>&quot;Default Message&#39;s value Avro data schema, composed of the key again and any string message&quot;</span>
<a id=__codelineno-41-19 name=__codelineno-41-19 href=#__codelineno-41-19></a><span class=o>}</span>
</code></pre></div> <p>If I now decided that my events should contain another attribute, I would modify the event value schema (<a href=https://github.com/ibm-cloud-architecture/refarch-eda-tools/blob/master/labs/es-cloud-schema-lab/avro_files/default_value.avsc>default_value.avsc</a>) to reflect that as well as <code>ProduceAvroMessage.py</code> to send that new attribute in the event it sends:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=c1># python ProduceAvroMessage.py test</span>
<a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a> @@@ Executing script: ProduceAvroMessage.py
<a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a>The arguments <span class=k>for</span> the script are:  <span class=o>[</span><span class=s1>&#39;ProduceAvroMessage.py&#39;</span>, <span class=s1>&#39;test&#39;</span><span class=o>]</span>
<a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a>Creating event...
<a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a>DONE
<a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a>--- Container event to be published: ---
<a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a><span class=o>{</span><span class=s1>&#39;eventKey&#39;</span>: <span class=s1>&#39;1&#39;</span>, <span class=s1>&#39;message&#39;</span>: <span class=s1>&#39;This is a test message&#39;</span>, <span class=s1>&#39;anotherAttribute&#39;</span>: <span class=s1>&#39;This is another atttribute&#39;</span><span class=o>}</span>
<a id=__codelineno-42-8 name=__codelineno-42-8 href=#__codelineno-42-8></a>----------------------------------------
<a id=__codelineno-42-9 name=__codelineno-42-9 href=#__codelineno-42-9></a>--- This is the configuration <span class=k>for</span> the avro producer: ---
<a id=__codelineno-42-10 name=__codelineno-42-10 href=#__codelineno-42-10></a><span class=o>{</span><span class=s1>&#39;bootstrap.servers&#39;</span>: <span class=s1>&#39;kafka-2.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093,kafka-1.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093,kafka-0.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093&#39;</span>, <span class=s1>&#39;schema.registry.url&#39;</span>: <span class=s1>&#39;https://token:4uk9gZ-n85a2esMoMZ5wtW-yIq_29o3PrHVBEFBj67N0@mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud/confluent&#39;</span>, <span class=s1>&#39;group.id&#39;</span>: <span class=s1>&#39;ProduceAvroMessagePython&#39;</span>, <span class=s1>&#39;security.protocol&#39;</span>: <span class=s1>&#39;SASL_SSL&#39;</span>, <span class=s1>&#39;sasl.mechanisms&#39;</span>: <span class=s1>&#39;PLAIN&#39;</span>, <span class=s1>&#39;sasl.username&#39;</span>: <span class=s1>&#39;token&#39;</span>, <span class=s1>&#39;sasl.password&#39;</span>: <span class=s1>&#39;*****&#39;</span><span class=o>}</span>
<a id=__codelineno-42-11 name=__codelineno-42-11 href=#__codelineno-42-11></a>---------------------------------------------------
<a id=__codelineno-42-12 name=__codelineno-42-12 href=#__codelineno-42-12></a>Message delivered to <span class=nb>test</span> <span class=o>[</span><span class=m>0</span><span class=o>]</span>
</code></pre></div> <p>I can see that an event with a new attribute has been sent:</p> <p><img alt=24 src=images/24.png></p> <p>And I can also see that the new shcema has got registered as well as a <strong>new version</strong> for the already exisiting schema:</p> <p><div class=highlight><pre><span></span><code><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a>$ curl -s -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/artifacts/test-value/versions
<a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a>
<a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a><span class=o>[</span><span class=m>1</span>,2<span class=o>]</span>
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a>$ curl -s -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/artifacts/test-value <span class=p>|</span> jq .
<a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a><span class=o>{</span>
<a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a>  <span class=s2>&quot;type&quot;</span>: <span class=s2>&quot;record&quot;</span>,
<a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a>  <span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;defaultValue&quot;</span>,
<a id=__codelineno-44-5 name=__codelineno-44-5 href=#__codelineno-44-5></a>  <span class=s2>&quot;namespace&quot;</span>: <span class=s2>&quot;ibm.eda.default&quot;</span>,
<a id=__codelineno-44-6 name=__codelineno-44-6 href=#__codelineno-44-6></a>  <span class=s2>&quot;fields&quot;</span>: <span class=o>[</span>
<a id=__codelineno-44-7 name=__codelineno-44-7 href=#__codelineno-44-7></a>    <span class=o>{</span>
<a id=__codelineno-44-8 name=__codelineno-44-8 href=#__codelineno-44-8></a>      <span class=s2>&quot;type&quot;</span>: <span class=s2>&quot;string&quot;</span>,
<a id=__codelineno-44-9 name=__codelineno-44-9 href=#__codelineno-44-9></a>      <span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;eventKey&quot;</span>,
<a id=__codelineno-44-10 name=__codelineno-44-10 href=#__codelineno-44-10></a>      <span class=s2>&quot;doc&quot;</span>: <span class=s2>&quot;We expect any string as the event key&quot;</span>
<a id=__codelineno-44-11 name=__codelineno-44-11 href=#__codelineno-44-11></a>    <span class=o>}</span>,
<a id=__codelineno-44-12 name=__codelineno-44-12 href=#__codelineno-44-12></a>    <span class=o>{</span>
<a id=__codelineno-44-13 name=__codelineno-44-13 href=#__codelineno-44-13></a>      <span class=s2>&quot;type&quot;</span>: <span class=s2>&quot;string&quot;</span>,
<a id=__codelineno-44-14 name=__codelineno-44-14 href=#__codelineno-44-14></a>      <span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;message&quot;</span>,
<a id=__codelineno-44-15 name=__codelineno-44-15 href=#__codelineno-44-15></a>      <span class=s2>&quot;doc&quot;</span>: <span class=s2>&quot;Any string message&quot;</span>
<a id=__codelineno-44-16 name=__codelineno-44-16 href=#__codelineno-44-16></a>    <span class=o>}</span>,
<a id=__codelineno-44-17 name=__codelineno-44-17 href=#__codelineno-44-17></a>    <span class=o>{</span>
<a id=__codelineno-44-18 name=__codelineno-44-18 href=#__codelineno-44-18></a>      <span class=s2>&quot;type&quot;</span>: <span class=s2>&quot;string&quot;</span>,
<a id=__codelineno-44-19 name=__codelineno-44-19 href=#__codelineno-44-19></a>      <span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;anotherAttribute&quot;</span>,
<a id=__codelineno-44-20 name=__codelineno-44-20 href=#__codelineno-44-20></a>      <span class=s2>&quot;doc&quot;</span>: <span class=s2>&quot;Another string attribute for demo&quot;</span>
<a id=__codelineno-44-21 name=__codelineno-44-21 href=#__codelineno-44-21></a>    <span class=o>}</span>
<a id=__codelineno-44-22 name=__codelineno-44-22 href=#__codelineno-44-22></a>  <span class=o>]</span>,
<a id=__codelineno-44-23 name=__codelineno-44-23 href=#__codelineno-44-23></a>  <span class=s2>&quot;doc&quot;</span>: <span class=s2>&quot;Default Message&#39;s value Avro data schema, composed of the key again and any string message&quot;</span>
<a id=__codelineno-44-24 name=__codelineno-44-24 href=#__codelineno-44-24></a><span class=o>}</span>
</code></pre></div></p> <p><inlinenotification kind=error></p> <p><strong>SECURITY:</strong> As some of you may have already thought, having your clients (that is your applications), auto-register the Avro data schemas that are in the end kind of the contracts that your components of your overal solution agree on in order to understand each other and collaborate between them is <strong>NOT</strong> a good idea. Specially in microservices architectures where you might have hundreds of microservices talking and collaborating among themselsves. We will see in the <a href=#security>Security</a> section how we can control schema registration and evolution based on roles at the schema level also.</p> <p></inlinenotification></p> <h3 id=create-a-non-compliant-message>Create a non-compliant message<a class=headerlink href=#create-a-non-compliant-message title="Permanent link">&para;</a></h3> <p>Now, we are trying to send a non-compliant message according to the Avro data schema we have for our events. Im going to try to send the following event:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a><span class=o>{</span>
<a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a>    <span class=s1>&#39;eventKey&#39;</span>: <span class=s1>&#39;1&#39;</span>,
<a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a>    <span class=s1>&#39;message&#39;</span>: <span class=s1>&#39;This is a test message&#39;</span>,
<a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a>    <span class=s1>&#39;anotherAttribute&#39;</span>: <span class=s1>&#39;This is another atttribute&#39;</span>,
<a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a>    <span class=s1>&#39;yetAnotherAttribute&#39;</span>: <span class=s1>&#39;This should fail&#39;</span>
<a id=__codelineno-45-6 name=__codelineno-45-6 href=#__codelineno-45-6></a><span class=o>}</span>
</code></pre></div> <p>and this is the output of that attempt:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a><span class=c1># python ProduceAvroMessage.py test</span>
<a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a> @@@ Executing script: ProduceAvroMessage.py
<a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a>The arguments <span class=k>for</span> the script are:  <span class=o>[</span><span class=s1>&#39;ProduceAvroMessage.py&#39;</span>, <span class=s1>&#39;test&#39;</span><span class=o>]</span>
<a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a>Creating event...
<a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a>DONE
<a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a>--- Container event to be published: ---
<a id=__codelineno-46-7 name=__codelineno-46-7 href=#__codelineno-46-7></a><span class=o>{</span><span class=s1>&#39;eventKey&#39;</span>: <span class=s1>&#39;1&#39;</span>, <span class=s1>&#39;message&#39;</span>: <span class=s1>&#39;This is a test message&#39;</span>, <span class=s1>&#39;anotherAttribute&#39;</span>: <span class=s1>&#39;This is another atttribute&#39;</span>, <span class=s1>&#39;yetAnotherAttribute&#39;</span>: <span class=s1>&#39;This should fail&#39;</span><span class=o>}</span>
<a id=__codelineno-46-8 name=__codelineno-46-8 href=#__codelineno-46-8></a>----------------------------------------
<a id=__codelineno-46-9 name=__codelineno-46-9 href=#__codelineno-46-9></a>--- This is the configuration <span class=k>for</span> the avro producer: ---
<a id=__codelineno-46-10 name=__codelineno-46-10 href=#__codelineno-46-10></a><span class=o>{</span><span class=s1>&#39;bootstrap.servers&#39;</span>: <span class=s1>&#39;kafka-2.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093,kafka-1.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093,kafka-0.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093&#39;</span>, <span class=s1>&#39;schema.registry.url&#39;</span>: <span class=s1>&#39;https://token:4uk9gZ-n85a2esMoMZ5wtW-yIq_29o3PrHVBEFBj67N0@mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud/confluent&#39;</span>, <span class=s1>&#39;group.id&#39;</span>: <span class=s1>&#39;ProduceAvroMessagePython&#39;</span>, <span class=s1>&#39;security.protocol&#39;</span>: <span class=s1>&#39;SASL_SSL&#39;</span>, <span class=s1>&#39;sasl.mechanisms&#39;</span>: <span class=s1>&#39;PLAIN&#39;</span>, <span class=s1>&#39;sasl.username&#39;</span>: <span class=s1>&#39;token&#39;</span>, <span class=s1>&#39;sasl.password&#39;</span>: <span class=s1>&#39;*****&#39;</span><span class=o>}</span>
<a id=__codelineno-46-11 name=__codelineno-46-11 href=#__codelineno-46-11></a>---------------------------------------------------
<a id=__codelineno-46-12 name=__codelineno-46-12 href=#__codelineno-46-12></a>Traceback <span class=o>(</span>most recent call last<span class=o>)</span>:
<a id=__codelineno-46-13 name=__codelineno-46-13 href=#__codelineno-46-13></a>  File <span class=s2>&quot;ProduceAvroMessage.py&quot;</span>, line <span class=m>77</span>, <span class=k>in</span> &lt;module&gt;
<a id=__codelineno-46-14 name=__codelineno-46-14 href=#__codelineno-46-14></a>    kp.publishEvent<span class=o>(</span>TOPIC_NAME,message_event,<span class=s2>&quot;eventKey&quot;</span><span class=o>)</span>
<a id=__codelineno-46-15 name=__codelineno-46-15 href=#__codelineno-46-15></a>  File <span class=s2>&quot;/tmp/lab/kafka/KcAvroProducer.py&quot;</span>, line <span class=m>39</span>, <span class=k>in</span> publishEvent
<a id=__codelineno-46-16 name=__codelineno-46-16 href=#__codelineno-46-16></a>    self.producer.produce<span class=o>(</span><span class=nv>topic</span><span class=o>=</span>topicName,value<span class=o>=</span>json.loads<span class=o>(</span>value<span class=o>)</span>,key<span class=o>=</span>json.loads<span class=o>(</span>value<span class=o>)[</span>key<span class=o>]</span>, <span class=nv>callback</span><span class=o>=</span>self.delivery_report<span class=o>)</span>
<a id=__codelineno-46-17 name=__codelineno-46-17 href=#__codelineno-46-17></a>  File <span class=s2>&quot;/root/.local/lib/python3.7/site-packages/confluent_kafka/avro/__init__.py&quot;</span>, line <span class=m>99</span>, <span class=k>in</span> produce
<a id=__codelineno-46-18 name=__codelineno-46-18 href=#__codelineno-46-18></a>    <span class=nv>value</span> <span class=o>=</span> self._serializer.encode_record_with_schema<span class=o>(</span>topic, value_schema, value<span class=o>)</span>
<a id=__codelineno-46-19 name=__codelineno-46-19 href=#__codelineno-46-19></a>  File <span class=s2>&quot;/root/.local/lib/python3.7/site-packages/confluent_kafka/avro/serializer/message_serializer.py&quot;</span>, line <span class=m>118</span>, <span class=k>in</span> encode_record_with_schema
<a id=__codelineno-46-20 name=__codelineno-46-20 href=#__codelineno-46-20></a>    <span class=k>return</span> self.encode_record_with_schema_id<span class=o>(</span>schema_id, record, <span class=nv>is_key</span><span class=o>=</span>is_key<span class=o>)</span>
<a id=__codelineno-46-21 name=__codelineno-46-21 href=#__codelineno-46-21></a>  File <span class=s2>&quot;/root/.local/lib/python3.7/site-packages/confluent_kafka/avro/serializer/message_serializer.py&quot;</span>, line <span class=m>152</span>, <span class=k>in</span> encode_record_with_schema_id
<a id=__codelineno-46-22 name=__codelineno-46-22 href=#__codelineno-46-22></a>    writer<span class=o>(</span>record, outf<span class=o>)</span>
<a id=__codelineno-46-23 name=__codelineno-46-23 href=#__codelineno-46-23></a>  File <span class=s2>&quot;/root/.local/lib/python3.7/site-packages/confluent_kafka/avro/serializer/message_serializer.py&quot;</span>, line <span class=m>86</span>, <span class=k>in</span> &lt;lambda&gt;
<a id=__codelineno-46-24 name=__codelineno-46-24 href=#__codelineno-46-24></a>    <span class=k>return</span> lambda record, fp: writer.write<span class=o>(</span>record, avro.io.BinaryEncoder<span class=o>(</span>fp<span class=o>))</span>
<a id=__codelineno-46-25 name=__codelineno-46-25 href=#__codelineno-46-25></a>  File <span class=s2>&quot;/root/.local/lib/python3.7/site-packages/avro/io.py&quot;</span>, line <span class=m>771</span>, <span class=k>in</span> write
<a id=__codelineno-46-26 name=__codelineno-46-26 href=#__codelineno-46-26></a>    raise AvroTypeException<span class=o>(</span>self.writer_schema, datum<span class=o>)</span>
<a id=__codelineno-46-27 name=__codelineno-46-27 href=#__codelineno-46-27></a>avro.io.AvroTypeException: The datum <span class=o>{</span><span class=s1>&#39;eventKey&#39;</span>: <span class=s1>&#39;1&#39;</span>, <span class=s1>&#39;message&#39;</span>: <span class=s1>&#39;This is a test message&#39;</span>, <span class=s1>&#39;anotherAttribute&#39;</span>: <span class=s1>&#39;This is another atttribute&#39;</span>, <span class=s1>&#39;yetAnotherAttribute&#39;</span>: <span class=s1>&#39;This should fail&#39;</span><span class=o>}</span> is not an example of the schema <span class=o>{</span>
<a id=__codelineno-46-28 name=__codelineno-46-28 href=#__codelineno-46-28></a>  <span class=s2>&quot;type&quot;</span>: <span class=s2>&quot;record&quot;</span>,
<a id=__codelineno-46-29 name=__codelineno-46-29 href=#__codelineno-46-29></a>  <span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;defaultValue&quot;</span>,
<a id=__codelineno-46-30 name=__codelineno-46-30 href=#__codelineno-46-30></a>  <span class=s2>&quot;namespace&quot;</span>: <span class=s2>&quot;ibm.eda.default&quot;</span>,
<a id=__codelineno-46-31 name=__codelineno-46-31 href=#__codelineno-46-31></a>  <span class=s2>&quot;fields&quot;</span>: <span class=o>[</span>
<a id=__codelineno-46-32 name=__codelineno-46-32 href=#__codelineno-46-32></a>    <span class=o>{</span>
<a id=__codelineno-46-33 name=__codelineno-46-33 href=#__codelineno-46-33></a>      <span class=s2>&quot;type&quot;</span>: <span class=s2>&quot;string&quot;</span>,
<a id=__codelineno-46-34 name=__codelineno-46-34 href=#__codelineno-46-34></a>      <span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;eventKey&quot;</span>,
<a id=__codelineno-46-35 name=__codelineno-46-35 href=#__codelineno-46-35></a>      <span class=s2>&quot;doc&quot;</span>: <span class=s2>&quot;We expect any string as the event key&quot;</span>
<a id=__codelineno-46-36 name=__codelineno-46-36 href=#__codelineno-46-36></a>    <span class=o>}</span>,
<a id=__codelineno-46-37 name=__codelineno-46-37 href=#__codelineno-46-37></a>    <span class=o>{</span>
<a id=__codelineno-46-38 name=__codelineno-46-38 href=#__codelineno-46-38></a>      <span class=s2>&quot;type&quot;</span>: <span class=s2>&quot;string&quot;</span>,
<a id=__codelineno-46-39 name=__codelineno-46-39 href=#__codelineno-46-39></a>      <span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;message&quot;</span>,
<a id=__codelineno-46-40 name=__codelineno-46-40 href=#__codelineno-46-40></a>      <span class=s2>&quot;doc&quot;</span>: <span class=s2>&quot;Any string message&quot;</span>
<a id=__codelineno-46-41 name=__codelineno-46-41 href=#__codelineno-46-41></a>    <span class=o>}</span>,
<a id=__codelineno-46-42 name=__codelineno-46-42 href=#__codelineno-46-42></a>    <span class=o>{</span>
<a id=__codelineno-46-43 name=__codelineno-46-43 href=#__codelineno-46-43></a>      <span class=s2>&quot;type&quot;</span>: <span class=s2>&quot;string&quot;</span>,
<a id=__codelineno-46-44 name=__codelineno-46-44 href=#__codelineno-46-44></a>      <span class=s2>&quot;name&quot;</span>: <span class=s2>&quot;anotherAttribute&quot;</span>,
<a id=__codelineno-46-45 name=__codelineno-46-45 href=#__codelineno-46-45></a>      <span class=s2>&quot;doc&quot;</span>: <span class=s2>&quot;Another string attribute for demo&quot;</span>
<a id=__codelineno-46-46 name=__codelineno-46-46 href=#__codelineno-46-46></a>    <span class=o>}</span>
<a id=__codelineno-46-47 name=__codelineno-46-47 href=#__codelineno-46-47></a>  <span class=o>]</span>,
<a id=__codelineno-46-48 name=__codelineno-46-48 href=#__codelineno-46-48></a>  <span class=s2>&quot;doc&quot;</span>: <span class=s2>&quot;Default Message&#39;s value Avro data schema, composed of the key again and any string message&quot;</span>
<a id=__codelineno-46-49 name=__codelineno-46-49 href=#__codelineno-46-49></a><span class=o>}</span>
</code></pre></div> <p>As we can see, the attempt failed as the Avro producer will check the message against the Avro data schema defined for the topic we want to send the message to and yield that this message does not comply.</p> <p>Therefore, using Avro schemas with IBM Event Streams give us the ability to build our system with <strong>robustness</strong> protecting downstream data consumers from malformed data, as only valid data will be permitted in the topic.</p> <h3 id=consume-a-message>Consume a message<a class=headerlink href=#consume-a-message title="Permanent link">&para;</a></h3> <p>In order to consume a message, we execute the <code>ConsumeAvroMessage.py</code> within the <code>/tmp/lab/src</code> folder in our python demo environment:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=c1># python ConsumeAvroMessage.py test</span>
<a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a> @@@ Executing script: ConsumeAvroMessage.py
<a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a>The arguments <span class=k>for</span> the script are:  <span class=o>[</span><span class=s1>&#39;ConsumeAvroMessage.py&#39;</span>, <span class=s1>&#39;test&#39;</span><span class=o>]</span>
<a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a>--- This is the configuration <span class=k>for</span> the Avro consumer: ---
<a id=__codelineno-47-5 name=__codelineno-47-5 href=#__codelineno-47-5></a><span class=o>{</span><span class=s1>&#39;bootstrap.servers&#39;</span>: <span class=s1>&#39;kafka-2.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093,kafka-1.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093,kafka-0.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093&#39;</span>, <span class=s1>&#39;group.id&#39;</span>: <span class=s1>&#39;pythonconsumers&#39;</span>, <span class=s1>&#39;auto.offset.reset&#39;</span>: <span class=s1>&#39;earliest&#39;</span>, <span class=s1>&#39;schema.registry.url&#39;</span>: <span class=s1>&#39;https://token:4uk9gZ-n85a2esMoMZ5wtW-yIq_29o3PrHVBEFBj67N0@mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud/confluent&#39;</span>, <span class=s1>&#39;enable.auto.commit&#39;</span>: True, <span class=s1>&#39;security.protocol&#39;</span>: <span class=s1>&#39;SASL_SSL&#39;</span>, <span class=s1>&#39;sasl.mechanisms&#39;</span>: <span class=s1>&#39;PLAIN&#39;</span>, <span class=s1>&#39;sasl.username&#39;</span>: <span class=s1>&#39;token&#39;</span>, <span class=s1>&#39;sasl.password&#39;</span>: <span class=s1>&#39;*****&#39;</span><span class=o>}</span>
<a id=__codelineno-47-6 name=__codelineno-47-6 href=#__codelineno-47-6></a>---------------------------------------------------
<a id=__codelineno-47-7 name=__codelineno-47-7 href=#__codelineno-47-7></a><span class=o>[</span>Message<span class=o>]</span> - Next message consumed from <span class=nb>test</span> partition: <span class=o>[</span><span class=m>0</span><span class=o>]</span> at offset <span class=m>0</span> with key <span class=m>1</span>:
<a id=__codelineno-47-8 name=__codelineno-47-8 href=#__codelineno-47-8></a>    value: <span class=o>{</span><span class=s1>&#39;eventKey&#39;</span>: <span class=s1>&#39;1&#39;</span>, <span class=s1>&#39;message&#39;</span>: <span class=s1>&#39;This is a test message&#39;</span><span class=o>}</span>
<a id=__codelineno-47-9 name=__codelineno-47-9 href=#__codelineno-47-9></a>
<a id=__codelineno-47-10 name=__codelineno-47-10 href=#__codelineno-47-10></a><span class=c1># python ConsumeAvroMessage.py test</span>
<a id=__codelineno-47-11 name=__codelineno-47-11 href=#__codelineno-47-11></a> @@@ Executing script: ConsumeAvroMessage.py
<a id=__codelineno-47-12 name=__codelineno-47-12 href=#__codelineno-47-12></a>The arguments <span class=k>for</span> the script are:  <span class=o>[</span><span class=s1>&#39;ConsumeAvroMessage.py&#39;</span>, <span class=s1>&#39;test&#39;</span><span class=o>]</span>
<a id=__codelineno-47-13 name=__codelineno-47-13 href=#__codelineno-47-13></a>--- This is the configuration <span class=k>for</span> the Avro consumer: ---
<a id=__codelineno-47-14 name=__codelineno-47-14 href=#__codelineno-47-14></a><span class=o>{</span><span class=s1>&#39;bootstrap.servers&#39;</span>: <span class=s1>&#39;kafka-2.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093,kafka-1.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093,kafka-0.mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud:9093&#39;</span>, <span class=s1>&#39;group.id&#39;</span>: <span class=s1>&#39;pythonconsumers&#39;</span>, <span class=s1>&#39;auto.offset.reset&#39;</span>: <span class=s1>&#39;earliest&#39;</span>, <span class=s1>&#39;schema.registry.url&#39;</span>: <span class=s1>&#39;https://token:4uk9gZ-n85a2esMoMZ5wtW-yIq_29o3PrHVBEFBj67N0@mh-tcqsppdpzlrkdmkbgmgl-4c201a12d7add7c99d2b22e361c6f175-0000.eu-de.containers.appdomain.cloud/confluent&#39;</span>, <span class=s1>&#39;enable.auto.commit&#39;</span>: True, <span class=s1>&#39;security.protocol&#39;</span>: <span class=s1>&#39;SASL_SSL&#39;</span>, <span class=s1>&#39;sasl.mechanisms&#39;</span>: <span class=s1>&#39;PLAIN&#39;</span>, <span class=s1>&#39;sasl.username&#39;</span>: <span class=s1>&#39;token&#39;</span>, <span class=s1>&#39;sasl.password&#39;</span>: <span class=s1>&#39;*****&#39;</span><span class=o>}</span>
<a id=__codelineno-47-15 name=__codelineno-47-15 href=#__codelineno-47-15></a>---------------------------------------------------
<a id=__codelineno-47-16 name=__codelineno-47-16 href=#__codelineno-47-16></a><span class=o>[</span>Message<span class=o>]</span> - Next message consumed from <span class=nb>test</span> partition: <span class=o>[</span><span class=m>0</span><span class=o>]</span> at offset <span class=m>1</span> with key <span class=m>1</span>:
<a id=__codelineno-47-17 name=__codelineno-47-17 href=#__codelineno-47-17></a>    value: <span class=o>{</span><span class=s1>&#39;eventKey&#39;</span>: <span class=s1>&#39;1&#39;</span>, <span class=s1>&#39;message&#39;</span>: <span class=s1>&#39;This is a test message&#39;</span>, <span class=s1>&#39;anotherAttribute&#39;</span>: <span class=s1>&#39;This is another atttribute&#39;</span><span class=o>}</span>
</code></pre></div> <p>As you can see, our script was able to read the Avro messages from the <code>test</code> topic and map that back to their original structure thanks to the Avro schemas:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=o>[</span>Message<span class=o>]</span> - Next message consumed from <span class=nb>test</span> partition: <span class=o>[</span><span class=m>0</span><span class=o>]</span> at offset <span class=m>0</span> with key <span class=m>1</span>:
<a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a>    value: <span class=o>{</span><span class=s1>&#39;eventKey&#39;</span>: <span class=s1>&#39;1&#39;</span>, <span class=s1>&#39;message&#39;</span>: <span class=s1>&#39;This is a test message&#39;</span><span class=o>}</span>
<a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a>
<a id=__codelineno-48-4 name=__codelineno-48-4 href=#__codelineno-48-4></a><span class=o>[</span>Message<span class=o>]</span> - Next message consumed from - <span class=nb>test</span> partition: <span class=o>[</span><span class=m>0</span><span class=o>]</span> at offset <span class=m>1</span> with key <span class=m>1</span>:
<a id=__codelineno-48-5 name=__codelineno-48-5 href=#__codelineno-48-5></a>    value: <span class=o>{</span><span class=s1>&#39;eventKey&#39;</span>: <span class=s1>&#39;1&#39;</span>, <span class=s1>&#39;message&#39;</span>: <span class=s1>&#39;This is a test message&#39;</span>, <span class=s1>&#39;anotherAttribute&#39;</span>: <span class=s1>&#39;This is another atttribute&#39;</span><span class=o>}</span>
</code></pre></div> <h2 id=data-evolution>Data Evolution<a class=headerlink href=#data-evolution title="Permanent link">&para;</a></h2> <p>So far we have more or less seen what Avro is, what an Avro data schema is, what a schema registry is and how this all works together. From creating an Avro data schema for your messages/events to comply with to how the schema registry and Avro data schemas work together. And we have also seen the code for doing all this, from the python code to send and receive Avro encoded messages based on their Avro data schemas to the rich API the IBM Event Streams on IBM Cloud schema registry provides to interact with.</p> <p>However, we have said little about the need for data to evolve. When you design an Event Driven architecture for your application (by applying <a href=https://ibm-cloud-architecture.github.io/refarch-eda/methodology/event-storming/ >Event Storming</a> or <a href=https://ibm-cloud-architecture.github.io/refarch-eda/methodology/domain-driven-design/ >Domain Driven Design</a> for example), it is very hard to come up with data structures/schemas that will not need to evolve/change in time. That is, your data, like your use or business cases, may need to evolve. As a result, Avro data schemas must be somehow flexible to allow your data to evolve along with your application and use cases.</p> <p>But it is not as easy as adding or removing data that travels in your events/messages or modifying the type of such data. And one of the reasons for this is that Kafka (or any other type of event backbone) is many times used as the source of truth. That is, a place that you can trust as to what has happened. Hence, Kafka will serve as the event source of truth where all the events (that is, data) that happened (which could be bank transactions, communications, etc) will get stored (sometimes up to <a href=https://www.confluent.io/blog/publishing-apache-kafka-new-york-times/ >hundreds of years</a>) and will be able to be replayed if needed. As a result, there must be a data schema management and data schema evolution put in place that allow the <strong>compatibility</strong> of old and new data schemas and, in fact, old and new data at the end of the day.</p> <p>The IBM Event Streams on IBM Cloud schema registry supports enforcing compatibility rules when creating a new version of a schema. If a request is made to create a new schema version that does not conform to the required compatibility rule, then the registry will reject the request. The following rules are supported:</p> <table> <thead> <tr> <th>Compatibility</th> <th>Tested against</th> <th>Descrition</th> </tr> </thead> <tbody> <tr> <td>NONE</td> <td>N/A</td> <td>No compatibility checking is performed when a new schema version is created</td> </tr> <tr> <td>BACKWARD</td> <td>Latest version of the schema</td> <td>A new version of the schema can omit fields that are present in the existing version of the schema. A new version of the schema can add optional fields that are not present in the existing version of the schema.</td> </tr> <tr> <td>BACKWARD_TRANSITIVE</td> <td>All versions of the schema</td> <td>Same as above</td> </tr> <tr> <td>FORWARD</td> <td>Latest version of the schema</td> <td>A new version of the schema can add fields that are not present in the existing version of the schema. A new version of the schema can omit optional fields that are present in the existing version of the schema.</td> </tr> <tr> <td>FORWARD_TRANSITIVE</td> <td>All versions of the schema</td> <td>Same as above</td> </tr> <tr> <td>FULL</td> <td>Latest version of the schema</td> <td>A new version of the schema can add optional fields that are not present in the existing version of the schema. A new version of the schema can omit optional fields that are present in the existing version of the schema.</td> </tr> <tr> <td>FULL_TRANSITIVE</td> <td>All versions of the schema</td> <td>Same as above</td> </tr> </tbody> </table> <p>These rules can be applied at two <strong>scopes</strong>:</p> <ol> <li><strong>At a global scope</strong>, which is the default that</li> <li><strong>At a per-schema level</strong>. If a per-schema level rule is defined, then this overrides the global default for the particular schema.</li> </ol> <p>By default, the registry has a global compatibility rule setting of <strong>NONE</strong>. Per-schema level rules must be defined otherwise the schema will default to using the global setting.</p> <h3 id=rules>Rules<a class=headerlink href=#rules title="Permanent link">&para;</a></h3> <p>In this section we are going to see how to interact with the schema registry in order to alter the compatibility rules both at the global and per-schema level.</p> <h4 id=get-the-current-value-of-a-global-rule>Get the current value of a global rule<a class=headerlink href=#get-the-current-value-of-a-global-rule title="Permanent link">&para;</a></h4> <p>The current value of a global rule is retrieved by issuing a GET request to the <code>/rules/{rule-type}</code> endpoint, (where <code>{rule-type}</code> is the type of global rule to be retrieved - currently the <strong>only supported type is COMPATIBILITY</strong>). If the request is successful then the current rule configuration is returned in the payload of the response, together with a status code of 200 (OK).</p> <p>Getting global rule configuration requires at least:</p> <ul> <li> <p>Reader role access to the Event Streams cluster resource type</p> </li> <li> <p>Get the current value for the <code>COMPATIBILITY</code> global rule with</p> <p><code>curl -u token:$KAFKA_APIKEY $URL/rules/COMPATIBILITY</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/rules/COMPATIBILITY
<a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a>
<a id=__codelineno-49-3 name=__codelineno-49-3 href=#__codelineno-49-3></a><span class=o>{</span><span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;COMPATIBILITY&quot;</span>,<span class=s2>&quot;config&quot;</span>:<span class=s2>&quot;NONE&quot;</span><span class=o>}</span>
</code></pre></div> </li> </ul> <p>As already explained, the default out of the box global compatibility rule for IBM Event Streams on IBM Cloud schema registry is <code>NONE</code>.</p> <h4 id=update-a-global-rule>Update a global rule<a class=headerlink href=#update-a-global-rule title="Permanent link">&para;</a></h4> <p>Global compatibility rules can be updated by issuing a PUT request to the <code>/rules/{rule-type}</code> endpoint, (where <code>{rule-type}</code> identifies the type of global rule to be updated - currently the only supported type is COMPATIBILITY), with the new rule configuration in the body of the request. If the request is successful then the newly updated rule config is returned in the payload of the response, together with a status code of 200 (OK).</p> <p>Updating a global rule configuration requires at least:</p> <ul> <li> <p>Manager role access to the Event Streams cluster resource type</p> </li> <li> <p>Update the compatibility globar rule from NONE to FORWARD with:</p> <p><code>curl -u token:$KAFKA_APIKEY X PUT $URL/rules/COMPATIBILITY -d '{"type":"COMPATIBILITY","config":"&lt;COMPATIBILITY_MODE&gt;"}'</code></p> <p><div class=highlight><pre><span></span><code><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a>$  curl -u token:<span class=nv>$KAFKA_APIKEY</span> -X PUT <span class=nv>$URL</span>/rules/COMPATIBILITY -d <span class=s1>&#39;{&quot;type&quot;:&quot;COMPATIBILITY&quot;,&quot;config&quot;:&quot;FORWARD&quot;}&#39;</span>
<a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a>
<a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a><span class=o>{</span><span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;COMPATIBILITY&quot;</span>,<span class=s2>&quot;config&quot;</span>:<span class=s2>&quot;FORWARD&quot;</span><span class=o>}</span>
</code></pre></div> 1. Verify it has been changed:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/rules/COMPATIBILITY
<a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a>
<a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a><span class=o>{</span><span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;COMPATIBILITY&quot;</span>,<span class=s2>&quot;config&quot;</span>:<span class=s2>&quot;FORWARD&quot;</span><span class=o>}</span>
</code></pre></div> </li> </ul> <h4 id=get-a-per-schema-rule>Get a per-schema rule<a class=headerlink href=#get-a-per-schema-rule title="Permanent link">&para;</a></h4> <p>To retrieve the current value of a type of rule being applied to a specific schema, a GET request is made to the <code>/artifacts/{schema-id}/rules/{rule-type}</code> endpoint, (where <code>{schema-id}</code> is the ID of the schema, and <code>{rule-type}</code> is the type of global rule to be retrieved - currently the only supported type is COMPATIBILITY). If the request is successful then the current rule value is returned in the payload of the response, together with a status code of 200 (OK).</p> <p>Getting per-schema rules requires at least:</p> <ul> <li>Reader role access to the Event Streams cluster resource type</li> <li> <p>Reader role access to the schema resource to which the rule applies</p> </li> <li> <p>Get the compatibility rule for our <code>test-value</code> schema with:</p> <p><code>curl -u token:$KAFKA_APIKEY $URL/artifacts/&lt;YOUR_SCHEMA_ID&gt;/rules/COMPATIBILITY</code></p> <p><div class=highlight><pre><span></span><code><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/artifacts/test-value/rules/COMPATIBILITY
<a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a>
<a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a><span class=o>{</span><span class=s2>&quot;error_code&quot;</span>:404,<span class=s2>&quot;message&quot;</span>:<span class=s2>&quot;no compatibility rule exists for artifact &#39;test-value&#39;&quot;</span><span class=o>}</span>
</code></pre></div> which makes sense as we have not yet created a compatibility rule for the <code>test-value</code> schema</p> </li> </ul> <h4 id=create-a-per-schema-rule>Create a per-schema rule<a class=headerlink href=#create-a-per-schema-rule title="Permanent link">&para;</a></h4> <p>Rules can be applied to a specific schema, overriding any global rules which have been set, by making a POST request to the <code>/artifacts/{schema-id}/rules</code> endpoint, (where <code>{schema-id}</code> is the ID of the schema), with the type and value of the new rule contained in the body of the request, (currently the only supported type is COMPATIBILITY). If successful an empty response, and a status code of 204 (no content) is returned.</p> <p>Creating per-schema rules requires at least:</p> <ul> <li>Reader role access to the Event Streams cluster resource type</li> <li> <p>Manager role access to the schema resource for which the rule will apply</p> </li> <li> <p>Create a compatibility rule for our <code>test-value</code> schema with:</p> <p><code>curl -u token:$KAFKA_APIKEY $URL/artifacts/&lt;YOUR_SCHEMA_ID&gt;/rules -d '{"type":"COMPATIBILITY","config":"&lt;COMPATIBILITY_MODE&gt;"}'</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/artifacts/test-value/rules -d <span class=s1>&#39;{&quot;type&quot;:&quot;COMPATIBILITY&quot;,&quot;config&quot;:&quot;FULL&quot;}&#39;</span>
<a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a>
<a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a><span class=o>{</span><span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;COMPATIBILITY&quot;</span>,<span class=s2>&quot;config&quot;</span>:<span class=s2>&quot;FULL&quot;</span><span class=o>}</span>
</code></pre></div> </li> <li> <p>Make sure this compatibility rules has been created:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/artifacts/test-value/rules/COMPATIBILITY
<a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a>
<a id=__codelineno-54-3 name=__codelineno-54-3 href=#__codelineno-54-3></a><span class=o>{</span><span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;COMPATIBILITY&quot;</span>,<span class=s2>&quot;config&quot;</span>:<span class=s2>&quot;FULL&quot;</span><span class=o>}</span>
</code></pre></div> </li> </ul> <h4 id=update-a-per-schema-rule>Update a per-schema rule<a class=headerlink href=#update-a-per-schema-rule title="Permanent link">&para;</a></h4> <p>The rules applied to a specific schema are modified by making a PUT request to the <code>/artifacts/{schema-id}/rules/{rule-type}</code> endpoint, (where <code>{schema-id}</code> is the ID of the schema, and <code>{rule-type}</code> is the type of global rule to be retrieved - currently the only supported type is COMPATIBILITY). If the request is successful then the newly updated rule config is returned in the payload of the response, together with a status code of 200 (OK).</p> <p>Updating a per-schema rule requires at least:</p> <ul> <li>Reader role access to the Event Streams cluster resource type</li> <li> <p>Manager role access to the schema resource to which the rule applies</p> </li> <li> <p>Update the compatibility rule we have for our schema <code>test-value</code> with:</p> <p><code>curl -u token:$KAFKA_APIKEY X PUT $URL/artifacts/&lt;YOUR_SCHEMA_ID&gt;/rules/COMPATIBILITY -d '{"type":"COMPATIBILITY","config":"&lt;COMPATIBILITY_MODE&gt;"}'</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a>$  curl -u token:<span class=nv>$KAFKA_APIKEY</span> -X PUT <span class=nv>$URL</span>/artifacts/test-value/rules/COMPATIBILITY -d <span class=s1>&#39;{&quot;type&quot;:&quot;COMPATIBILITY&quot;,&quot;config&quot;:&quot;BACKWARD&quot;}&#39;</span>
<a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a>
<a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a><span class=o>{</span><span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;COMPATIBILITY&quot;</span>,<span class=s2>&quot;config&quot;</span>:<span class=s2>&quot;BACKWARD&quot;</span><span class=o>}</span>
</code></pre></div> </li> <li> <p>Make sure the compatibility mode for our <code>test-value</code> schema is as expected:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/artifacts/test-value/rules/COMPATIBILITY
<a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a>
<a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a><span class=o>{</span><span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;COMPATIBILITY&quot;</span>,<span class=s2>&quot;config&quot;</span>:<span class=s2>&quot;BACKWARD&quot;</span><span class=o>}</span>
</code></pre></div> </li> </ul> <h4 id=delete-a-per-schema-rule>Delete a per-schema rule<a class=headerlink href=#delete-a-per-schema-rule title="Permanent link">&para;</a></h4> <p>The rules applied to a specific schema are deleted by making a DELETE request to the <code>/artifacts/{schema-id}/rules/{rule-type}</code> endpoint, (where <code>{schema-id}</code> is the ID of the schema, and <code>{rule-type}</code> is the type of global rule to be retrieved - currently the only supported type is COMPATIBILITY). If the request is successful then an empty response is returned, with a status code of 204 (no content).</p> <p>Deleting a per-schema rule requires at least:</p> <ul> <li>Reader role access to the Event Streams cluster resource type</li> <li> <p>Manager role access to the schema resource to which the rule applies</p> </li> <li> <p>Delete the compatibility rule we have for our <code>test-value</code> schema with:</p> <p><code>curl -u token:$KAFKA_APIKEY X DELETE $URL/artifacts/&lt;YOUR_SCHEMA_ID&gt;/rules/COMPATIBILITY</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> -X DELETE <span class=nv>$URL</span>/artifacts/test-value/rules/COMPATIBILITY
</code></pre></div> </li> <li> <p>Make sure there is no compatibility rule for our <code>test-value</code> schema now:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/artifacts/test-value/rules/COMPATIBILITY
<a id=__codelineno-58-2 name=__codelineno-58-2 href=#__codelineno-58-2></a>
<a id=__codelineno-58-3 name=__codelineno-58-3 href=#__codelineno-58-3></a><span class=o>{</span><span class=s2>&quot;error_code&quot;</span>:404,<span class=s2>&quot;message&quot;</span>:<span class=s2>&quot;no compatibility rule exists for artifact &#39;test-value&#39;&quot;</span><span class=o>}</span>
</code></pre></div> </li> </ul> <h3 id=evolve-your-schemas>Evolve your schemas<a class=headerlink href=#evolve-your-schemas title="Permanent link">&para;</a></h3> <p>In this section, we are going to review the different compatibility modes for our Avro data schemas to evolve (hence our data). For simplicity though, we are going to to review only the following types of schema compatibility and at the global level:</p> <ol> <li>None</li> <li>Backward</li> <li>Forward</li> <li>Full</li> </ol> <h3 id=none>None<a class=headerlink href=#none title="Permanent link">&para;</a></h3> <p>First of all, set the compatibility mode to backwards at the global level (for simplicity):</p> <div class=highlight><pre><span></span><code><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> -X PUT <span class=nv>$URL</span>/rules/COMPATIBILITY -d <span class=s1>&#39;{&quot;type&quot;:&quot;COMPATIBILITY&quot;,&quot;config&quot;:&quot;NONE&quot;}&#39;</span>
<a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a>
<a id=__codelineno-59-3 name=__codelineno-59-3 href=#__codelineno-59-3></a><span class=o>{</span><span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;COMPATIBILITY&quot;</span>,<span class=s2>&quot;config&quot;</span>:<span class=s2>&quot;NONE&quot;</span><span class=o>}</span>
</code></pre></div> <p>This compatibility rule does not perform any compatibility check at all when a new schema version is created.</p> <p>That is, if we use the <code>test-value</code> schema we've used through this tutorial, and try to register a completely different schema like:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-60-2 name=__codelineno-60-2 href=#__codelineno-60-2></a><span class=w>    </span><span class=nt>&quot;namespace&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;ibm.eda.default&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-60-3 name=__codelineno-60-3 href=#__codelineno-60-3></a><span class=w>    </span><span class=nt>&quot;doc&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;New Default Message&#39;s value Avro data schema, completely different than its predecesors to demonstrate None compatibility&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-60-4 name=__codelineno-60-4 href=#__codelineno-60-4></a><span class=w>    </span><span class=nt>&quot;type&quot;</span><span class=p>:</span><span class=s2>&quot;record&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-60-5 name=__codelineno-60-5 href=#__codelineno-60-5></a><span class=w>    </span><span class=nt>&quot;name&quot;</span><span class=p>:</span><span class=s2>&quot;defaultValue&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-60-6 name=__codelineno-60-6 href=#__codelineno-60-6></a><span class=w>    </span><span class=nt>&quot;fields&quot;</span><span class=p>:[</span><span class=w></span>
<a id=__codelineno-60-7 name=__codelineno-60-7 href=#__codelineno-60-7></a><span class=w>            </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-60-8 name=__codelineno-60-8 href=#__codelineno-60-8></a><span class=w>                </span><span class=nt>&quot;name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;anAttribute&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-60-9 name=__codelineno-60-9 href=#__codelineno-60-9></a><span class=w>                </span><span class=nt>&quot;type&quot;</span><span class=p>:</span><span class=s2>&quot;int&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-60-10 name=__codelineno-60-10 href=#__codelineno-60-10></a><span class=w>                </span><span class=nt>&quot;doc&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;an attribute that is an integer&quot;</span><span class=w></span>
<a id=__codelineno-60-11 name=__codelineno-60-11 href=#__codelineno-60-11></a><span class=w>            </span><span class=p>},</span><span class=w></span>
<a id=__codelineno-60-12 name=__codelineno-60-12 href=#__codelineno-60-12></a><span class=w>            </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-60-13 name=__codelineno-60-13 href=#__codelineno-60-13></a><span class=w>                </span><span class=nt>&quot;name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;anotherAttribute&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-60-14 name=__codelineno-60-14 href=#__codelineno-60-14></a><span class=w>                </span><span class=nt>&quot;type&quot;</span><span class=p>:</span><span class=s2>&quot;long&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-60-15 name=__codelineno-60-15 href=#__codelineno-60-15></a><span class=w>                </span><span class=nt>&quot;doc&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;Just a long number&quot;</span><span class=w></span>
<a id=__codelineno-60-16 name=__codelineno-60-16 href=#__codelineno-60-16></a><span class=w>            </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-60-17 name=__codelineno-60-17 href=#__codelineno-60-17></a><span class=w>     </span><span class=p>]</span><span class=w></span>
<a id=__codelineno-60-18 name=__codelineno-60-18 href=#__codelineno-60-18></a><span class=p>}</span><span class=w></span>
</code></pre></div> <p>it should work:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a>$ curl  -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=se>\</span>
<a id=__codelineno-61-2 name=__codelineno-61-2 href=#__codelineno-61-2></a>        -H <span class=s1>&#39;Content-Type: application/json&#39;</span> <span class=se>\</span>
<a id=__codelineno-61-3 name=__codelineno-61-3 href=#__codelineno-61-3></a>        -H <span class=s1>&#39;X-Registry-ArtifactId: test-value&#39;</span> <span class=se>\</span>
<a id=__codelineno-61-4 name=__codelineno-61-4 href=#__codelineno-61-4></a>        <span class=nv>$URL</span>/artifacts/test-value/versions <span class=se>\</span>
<a id=__codelineno-61-5 name=__codelineno-61-5 href=#__codelineno-61-5></a>        -d <span class=s1>&#39;{   &quot;namespace&quot;: &quot;ibm.eda.default&quot;,</span>
<a id=__codelineno-61-6 name=__codelineno-61-6 href=#__codelineno-61-6></a><span class=s1>                &quot;doc&quot;: &quot;New Default Message value Avro data schema, completely different than its predecesors to demonstrate None compatibility&quot;,</span>
<a id=__codelineno-61-7 name=__codelineno-61-7 href=#__codelineno-61-7></a><span class=s1>                &quot;type&quot;:&quot;record&quot;,</span>
<a id=__codelineno-61-8 name=__codelineno-61-8 href=#__codelineno-61-8></a><span class=s1>                &quot;name&quot;:&quot;defaultValue&quot;,</span>
<a id=__codelineno-61-9 name=__codelineno-61-9 href=#__codelineno-61-9></a><span class=s1>                &quot;fields&quot;:[</span>
<a id=__codelineno-61-10 name=__codelineno-61-10 href=#__codelineno-61-10></a><span class=s1>                    {&quot;name&quot;: &quot;anAttribute&quot;,&quot;type&quot;:&quot;int&quot;,&quot;doc&quot;: &quot;an attribute that is an integer&quot;},</span>
<a id=__codelineno-61-11 name=__codelineno-61-11 href=#__codelineno-61-11></a><span class=s1>                    {&quot;name&quot;: &quot;anotherAttribute&quot;,&quot;type&quot;:&quot;long&quot;,&quot;doc&quot;: &quot;Just a long number&quot;}]}&#39;</span>
<a id=__codelineno-61-12 name=__codelineno-61-12 href=#__codelineno-61-12></a>
<a id=__codelineno-61-13 name=__codelineno-61-13 href=#__codelineno-61-13></a><span class=o>{</span><span class=s2>&quot;id&quot;</span>:<span class=s2>&quot;test-value&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;AVRO&quot;</span>,<span class=s2>&quot;version&quot;</span>:3,<span class=s2>&quot;createdBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;createdOn&quot;</span>:1589479701588,<span class=s2>&quot;modifiedBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;modifiedOn&quot;</span>:1589551226293,<span class=s2>&quot;globalId&quot;</span>:23<span class=o>}</span>
</code></pre></div> <p>As we can see, now the schema for the <code>test</code> topic will enforce that events coming into the topic are formed by an integer and a long number.</p> <h3 id=new-schema>New Schema<a class=headerlink href=#new-schema title="Permanent link">&para;</a></h3> <p>For the following compatibility modes, we are going to use a new schema to describe a person. It will be called <code>demo-schema</code> and will looks like this:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a><span class=w>    </span><span class=nt>&quot;namespace&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;schema.compatibility.test&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-62-3 name=__codelineno-62-3 href=#__codelineno-62-3></a><span class=w>    </span><span class=nt>&quot;name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;person&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-62-4 name=__codelineno-62-4 href=#__codelineno-62-4></a><span class=w>    </span><span class=nt>&quot;type&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;record&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-62-5 name=__codelineno-62-5 href=#__codelineno-62-5></a><span class=w>    </span><span class=nt>&quot;fields&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w></span>
<a id=__codelineno-62-6 name=__codelineno-62-6 href=#__codelineno-62-6></a><span class=w>        </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-62-7 name=__codelineno-62-7 href=#__codelineno-62-7></a><span class=w>            </span><span class=nt>&quot;name&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;name&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-62-8 name=__codelineno-62-8 href=#__codelineno-62-8></a><span class=w>            </span><span class=nt>&quot;type&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;string&quot;</span><span class=w></span>
<a id=__codelineno-62-9 name=__codelineno-62-9 href=#__codelineno-62-9></a><span class=w>        </span><span class=p>},</span><span class=w></span>
<a id=__codelineno-62-10 name=__codelineno-62-10 href=#__codelineno-62-10></a><span class=w>        </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-62-11 name=__codelineno-62-11 href=#__codelineno-62-11></a><span class=w>            </span><span class=nt>&quot;name&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;age&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-62-12 name=__codelineno-62-12 href=#__codelineno-62-12></a><span class=w>            </span><span class=nt>&quot;type&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;int&quot;</span><span class=w></span>
<a id=__codelineno-62-13 name=__codelineno-62-13 href=#__codelineno-62-13></a><span class=w>        </span><span class=p>},</span><span class=w></span>
<a id=__codelineno-62-14 name=__codelineno-62-14 href=#__codelineno-62-14></a><span class=w>        </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-62-15 name=__codelineno-62-15 href=#__codelineno-62-15></a><span class=w>            </span><span class=nt>&quot;name&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;gender&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-62-16 name=__codelineno-62-16 href=#__codelineno-62-16></a><span class=w>            </span><span class=nt>&quot;type&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;string&quot;</span><span class=w></span>
<a id=__codelineno-62-17 name=__codelineno-62-17 href=#__codelineno-62-17></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-62-18 name=__codelineno-62-18 href=#__codelineno-62-18></a><span class=w>    </span><span class=p>]</span><span class=w></span>
<a id=__codelineno-62-19 name=__codelineno-62-19 href=#__codelineno-62-19></a><span class=w> </span><span class=p>}</span><span class=w></span>
</code></pre></div> <ol> <li> <p>Register the schema:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a>$ curl  -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=se>\</span>
<a id=__codelineno-63-2 name=__codelineno-63-2 href=#__codelineno-63-2></a>        -H <span class=s1>&#39;Content-Type: application/json&#39;</span> <span class=se>\</span>
<a id=__codelineno-63-3 name=__codelineno-63-3 href=#__codelineno-63-3></a>        -H <span class=s1>&#39;X-Registry-ArtifactId: demo-schema&#39;</span> <span class=se>\</span>
<a id=__codelineno-63-4 name=__codelineno-63-4 href=#__codelineno-63-4></a>        <span class=nv>$URL</span>/artifacts <span class=se>\</span>
<a id=__codelineno-63-5 name=__codelineno-63-5 href=#__codelineno-63-5></a>        -d <span class=s1>&#39;{</span>
<a id=__codelineno-63-6 name=__codelineno-63-6 href=#__codelineno-63-6></a><span class=s1>            &quot;namespace&quot;: &quot;schema.compatibility.test&quot;,</span>
<a id=__codelineno-63-7 name=__codelineno-63-7 href=#__codelineno-63-7></a><span class=s1>            &quot;name&quot;: &quot;person&quot;,</span>
<a id=__codelineno-63-8 name=__codelineno-63-8 href=#__codelineno-63-8></a><span class=s1>            &quot;type&quot;: &quot;record&quot;,</span>
<a id=__codelineno-63-9 name=__codelineno-63-9 href=#__codelineno-63-9></a><span class=s1>            &quot;fields&quot; : [</span>
<a id=__codelineno-63-10 name=__codelineno-63-10 href=#__codelineno-63-10></a><span class=s1>                {&quot;name&quot; : &quot;name&quot;, &quot;type&quot; : &quot;string&quot;},</span>
<a id=__codelineno-63-11 name=__codelineno-63-11 href=#__codelineno-63-11></a><span class=s1>                {&quot;name&quot; : &quot;age&quot;, &quot;type&quot; : &quot;int&quot;},</span>
<a id=__codelineno-63-12 name=__codelineno-63-12 href=#__codelineno-63-12></a><span class=s1>                {&quot;name&quot; : &quot;gender&quot;, &quot;type&quot; : &quot;string&quot;}]}&#39;</span>
<a id=__codelineno-63-13 name=__codelineno-63-13 href=#__codelineno-63-13></a>
<a id=__codelineno-63-14 name=__codelineno-63-14 href=#__codelineno-63-14></a><span class=o>{</span><span class=s2>&quot;id&quot;</span>:<span class=s2>&quot;demo-schema&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;AVRO&quot;</span>,<span class=s2>&quot;version&quot;</span>:1,<span class=s2>&quot;createdBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;createdOn&quot;</span>:1589553367867,<span class=s2>&quot;modifiedBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;modifiedOn&quot;</span>:1589553367867,<span class=s2>&quot;globalId&quot;</span>:24<span class=o>}</span>
</code></pre></div> </li> </ol> <h3 id=backward>Backward<a class=headerlink href=#backward title="Permanent link">&para;</a></h3> <p>First of all, set the compatibility mode to backwards at the global level (for simplicity):</p> <div class=highlight><pre><span></span><code><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> -X PUT <span class=nv>$URL</span>/rules/COMPATIBILITY -d <span class=s1>&#39;{&quot;type&quot;:&quot;COMPATIBILITY&quot;,&quot;config&quot;:&quot;BACKWARD&quot;}&#39;</span>
<a id=__codelineno-64-2 name=__codelineno-64-2 href=#__codelineno-64-2></a>
<a id=__codelineno-64-3 name=__codelineno-64-3 href=#__codelineno-64-3></a><span class=o>{</span><span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;COMPATIBILITY&quot;</span>,<span class=s2>&quot;config&quot;</span>:<span class=s2>&quot;BACKWARD&quot;</span><span class=o>}</span>
</code></pre></div> <p>Now, What if we decide to change the data schema to add a new attribute such as place of birth? That is, the new schema would look like:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a><span class=w>    </span><span class=nt>&quot;namespace&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;schema.compatibility.test&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a><span class=w>    </span><span class=nt>&quot;name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;person&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-65-4 name=__codelineno-65-4 href=#__codelineno-65-4></a><span class=w>    </span><span class=nt>&quot;type&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;record&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-65-5 name=__codelineno-65-5 href=#__codelineno-65-5></a><span class=w>    </span><span class=nt>&quot;fields&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w></span>
<a id=__codelineno-65-6 name=__codelineno-65-6 href=#__codelineno-65-6></a><span class=w>        </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-65-7 name=__codelineno-65-7 href=#__codelineno-65-7></a><span class=w>            </span><span class=nt>&quot;name&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;name&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-65-8 name=__codelineno-65-8 href=#__codelineno-65-8></a><span class=w>            </span><span class=nt>&quot;type&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;string&quot;</span><span class=w></span>
<a id=__codelineno-65-9 name=__codelineno-65-9 href=#__codelineno-65-9></a><span class=w>        </span><span class=p>},</span><span class=w></span>
<a id=__codelineno-65-10 name=__codelineno-65-10 href=#__codelineno-65-10></a><span class=w>        </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-65-11 name=__codelineno-65-11 href=#__codelineno-65-11></a><span class=w>            </span><span class=nt>&quot;name&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;age&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-65-12 name=__codelineno-65-12 href=#__codelineno-65-12></a><span class=w>            </span><span class=nt>&quot;type&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;int&quot;</span><span class=w></span>
<a id=__codelineno-65-13 name=__codelineno-65-13 href=#__codelineno-65-13></a><span class=w>        </span><span class=p>},</span><span class=w></span>
<a id=__codelineno-65-14 name=__codelineno-65-14 href=#__codelineno-65-14></a><span class=w>        </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-65-15 name=__codelineno-65-15 href=#__codelineno-65-15></a><span class=w>            </span><span class=nt>&quot;name&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;gender&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-65-16 name=__codelineno-65-16 href=#__codelineno-65-16></a><span class=w>            </span><span class=nt>&quot;type&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;string&quot;</span><span class=w></span>
<a id=__codelineno-65-17 name=__codelineno-65-17 href=#__codelineno-65-17></a><span class=w>        </span><span class=p>},</span><span class=w></span>
<a id=__codelineno-65-18 name=__codelineno-65-18 href=#__codelineno-65-18></a><span class=w>        </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-65-19 name=__codelineno-65-19 href=#__codelineno-65-19></a><span class=w>            </span><span class=nt>&quot;name&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;place_of_birth&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-65-20 name=__codelineno-65-20 href=#__codelineno-65-20></a><span class=w>            </span><span class=nt>&quot;type&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;string&quot;</span><span class=w></span>
<a id=__codelineno-65-21 name=__codelineno-65-21 href=#__codelineno-65-21></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-65-22 name=__codelineno-65-22 href=#__codelineno-65-22></a><span class=w>    </span><span class=p>]</span><span class=w></span>
<a id=__codelineno-65-23 name=__codelineno-65-23 href=#__codelineno-65-23></a><span class=p>}</span><span class=w></span>
</code></pre></div> <p>If we try to create a new version for our <code>demo-schema</code> to include the <code>place_of_birth</code> attribute with the compatibility mode set to backwards, we will get the following:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-66-1 name=__codelineno-66-1 href=#__codelineno-66-1></a>$ curl  -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=se>\</span>
<a id=__codelineno-66-2 name=__codelineno-66-2 href=#__codelineno-66-2></a>        -H <span class=s1>&#39;Content-Type: application/json&#39;</span> <span class=se>\</span>
<a id=__codelineno-66-3 name=__codelineno-66-3 href=#__codelineno-66-3></a>        -H <span class=s1>&#39;X-Registry-ArtifactId: demo-schema&#39;</span> <span class=se>\</span>
<a id=__codelineno-66-4 name=__codelineno-66-4 href=#__codelineno-66-4></a>        <span class=nv>$URL</span>/artifacts/demo-schema/versions <span class=se>\</span>
<a id=__codelineno-66-5 name=__codelineno-66-5 href=#__codelineno-66-5></a>        -d <span class=s1>&#39;{</span>
<a id=__codelineno-66-6 name=__codelineno-66-6 href=#__codelineno-66-6></a><span class=s1>            &quot;namespace&quot;: &quot;schema.compatibility.test&quot;,</span>
<a id=__codelineno-66-7 name=__codelineno-66-7 href=#__codelineno-66-7></a><span class=s1>            &quot;name&quot;: &quot;person&quot;,</span>
<a id=__codelineno-66-8 name=__codelineno-66-8 href=#__codelineno-66-8></a><span class=s1>            &quot;type&quot;: &quot;record&quot;,</span>
<a id=__codelineno-66-9 name=__codelineno-66-9 href=#__codelineno-66-9></a><span class=s1>            &quot;fields&quot; : [</span>
<a id=__codelineno-66-10 name=__codelineno-66-10 href=#__codelineno-66-10></a><span class=s1>                {&quot;name&quot; : &quot;name&quot;, &quot;type&quot; : &quot;string&quot;},</span>
<a id=__codelineno-66-11 name=__codelineno-66-11 href=#__codelineno-66-11></a><span class=s1>                {&quot;name&quot; : &quot;age&quot;, &quot;type&quot; : &quot;int&quot;},</span>
<a id=__codelineno-66-12 name=__codelineno-66-12 href=#__codelineno-66-12></a><span class=s1>                {&quot;name&quot; : &quot;gender&quot;, &quot;type&quot; : &quot;string&quot;},</span>
<a id=__codelineno-66-13 name=__codelineno-66-13 href=#__codelineno-66-13></a><span class=s1>                {&quot;name&quot; : &quot;place_of_birth&quot;,&quot;type&quot; : &quot;string&quot;}]}&#39;</span>
<a id=__codelineno-66-14 name=__codelineno-66-14 href=#__codelineno-66-14></a>
<a id=__codelineno-66-15 name=__codelineno-66-15 href=#__codelineno-66-15></a><span class=o>{</span><span class=s2>&quot;error_code&quot;</span>:409,<span class=s2>&quot;message&quot;</span>:<span class=s2>&quot;Schema failed compatibility check with version ID: demo-schema, schema not backward compatible: reader&#39;s &#39;record&#39; schema named &#39;schema.compatibility.test.person&#39; contains a field named &#39;place_of_birth&#39; that does not match any field in the corresponding writer&#39;s schema. The reader&#39;s schema does not specify a default value for this field&quot;</span><span class=o>}</span>
</code></pre></div> <p>We see we get an error that says that the new schema version we are trying to register for our <code>demo-schema</code> is not backward compatible because <em>"reader's 'record' schema named 'schema.compatibility.test.person' contains a field named 'place_of_birth' that does not match any field in the corresponding writer's schema. The reader's schema does not specify a default value for this field"</em></p> <p>As the reason above explains, backward compatibility means that <strong>consumers using the new schema can read data produced with the last schema</strong>. As it stands at the moment, this is not satisfied since the consumer with the newer version expects the attribute <code>place_of_birth</code>.</p> <p>As the error explanation above also suggests, in order to include a new attribute in our schema when we have <strong>backward</strong> compatibility mode enabled, we need to provide a default value for it so that the consumer uses it when reading messages produced with the older version of the schema that will not include the newer attribute. That is, we need our newer schema version to be like:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-67-1 name=__codelineno-67-1 href=#__codelineno-67-1></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-67-2 name=__codelineno-67-2 href=#__codelineno-67-2></a><span class=w>    </span><span class=nt>&quot;namespace&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;schema.compatibility.test&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-67-3 name=__codelineno-67-3 href=#__codelineno-67-3></a><span class=w>    </span><span class=nt>&quot;name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;person&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-67-4 name=__codelineno-67-4 href=#__codelineno-67-4></a><span class=w>    </span><span class=nt>&quot;type&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;record&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-67-5 name=__codelineno-67-5 href=#__codelineno-67-5></a><span class=w>    </span><span class=nt>&quot;fields&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w></span>
<a id=__codelineno-67-6 name=__codelineno-67-6 href=#__codelineno-67-6></a><span class=w>        </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-67-7 name=__codelineno-67-7 href=#__codelineno-67-7></a><span class=w>            </span><span class=nt>&quot;name&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;name&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-67-8 name=__codelineno-67-8 href=#__codelineno-67-8></a><span class=w>            </span><span class=nt>&quot;type&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;string&quot;</span><span class=w></span>
<a id=__codelineno-67-9 name=__codelineno-67-9 href=#__codelineno-67-9></a><span class=w>        </span><span class=p>},</span><span class=w></span>
<a id=__codelineno-67-10 name=__codelineno-67-10 href=#__codelineno-67-10></a><span class=w>        </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-67-11 name=__codelineno-67-11 href=#__codelineno-67-11></a><span class=w>            </span><span class=nt>&quot;name&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;age&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-67-12 name=__codelineno-67-12 href=#__codelineno-67-12></a><span class=w>            </span><span class=nt>&quot;type&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;int&quot;</span><span class=w></span>
<a id=__codelineno-67-13 name=__codelineno-67-13 href=#__codelineno-67-13></a><span class=w>        </span><span class=p>},</span><span class=w></span>
<a id=__codelineno-67-14 name=__codelineno-67-14 href=#__codelineno-67-14></a><span class=w>        </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-67-15 name=__codelineno-67-15 href=#__codelineno-67-15></a><span class=w>            </span><span class=nt>&quot;name&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;gender&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-67-16 name=__codelineno-67-16 href=#__codelineno-67-16></a><span class=w>            </span><span class=nt>&quot;type&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;string&quot;</span><span class=w></span>
<a id=__codelineno-67-17 name=__codelineno-67-17 href=#__codelineno-67-17></a><span class=w>        </span><span class=p>},</span><span class=w></span>
<a id=__codelineno-67-18 name=__codelineno-67-18 href=#__codelineno-67-18></a><span class=w>        </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-67-19 name=__codelineno-67-19 href=#__codelineno-67-19></a><span class=w>            </span><span class=nt>&quot;name&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;place_of_birth&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-67-20 name=__codelineno-67-20 href=#__codelineno-67-20></a><span class=w>            </span><span class=nt>&quot;type&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;string&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-67-21 name=__codelineno-67-21 href=#__codelineno-67-21></a><span class=w>            </span><span class=nt>&quot;default&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;nonDefined&quot;</span><span class=w></span>
<a id=__codelineno-67-22 name=__codelineno-67-22 href=#__codelineno-67-22></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-67-23 name=__codelineno-67-23 href=#__codelineno-67-23></a><span class=w>    </span><span class=p>]</span><span class=w></span>
<a id=__codelineno-67-24 name=__codelineno-67-24 href=#__codelineno-67-24></a><span class=p>}</span><span class=w></span>
</code></pre></div> <p>so that the consumer will use <code>nonDefined</code> as the value for <code>place_of_birth</code> whenever it consumes messages produced with the older shcema version that do not include the attribute.</p> <p>Let's check:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-68-1 name=__codelineno-68-1 href=#__codelineno-68-1></a>$ curl  -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=se>\</span>
<a id=__codelineno-68-2 name=__codelineno-68-2 href=#__codelineno-68-2></a>        -H <span class=s1>&#39;Content-Type: application/json&#39;</span> <span class=se>\</span>
<a id=__codelineno-68-3 name=__codelineno-68-3 href=#__codelineno-68-3></a>        -H <span class=s1>&#39;X-Registry-ArtifactId: demo-schema&#39;</span> <span class=se>\</span>
<a id=__codelineno-68-4 name=__codelineno-68-4 href=#__codelineno-68-4></a>        <span class=nv>$URL</span>/artifacts/demo-schema/versions <span class=se>\</span>
<a id=__codelineno-68-5 name=__codelineno-68-5 href=#__codelineno-68-5></a>        -d <span class=s1>&#39;{</span>
<a id=__codelineno-68-6 name=__codelineno-68-6 href=#__codelineno-68-6></a><span class=s1>            &quot;namespace&quot;: &quot;schema.compatibility.test&quot;,</span>
<a id=__codelineno-68-7 name=__codelineno-68-7 href=#__codelineno-68-7></a><span class=s1>            &quot;name&quot;: &quot;person&quot;,</span>
<a id=__codelineno-68-8 name=__codelineno-68-8 href=#__codelineno-68-8></a><span class=s1>            &quot;type&quot;: &quot;record&quot;,</span>
<a id=__codelineno-68-9 name=__codelineno-68-9 href=#__codelineno-68-9></a><span class=s1>            &quot;fields&quot; : [</span>
<a id=__codelineno-68-10 name=__codelineno-68-10 href=#__codelineno-68-10></a><span class=s1>                {&quot;name&quot; : &quot;name&quot;, &quot;type&quot; : &quot;string&quot;},</span>
<a id=__codelineno-68-11 name=__codelineno-68-11 href=#__codelineno-68-11></a><span class=s1>                {&quot;name&quot; : &quot;age&quot;, &quot;type&quot; : &quot;int&quot;},</span>
<a id=__codelineno-68-12 name=__codelineno-68-12 href=#__codelineno-68-12></a><span class=s1>                {&quot;name&quot; : &quot;gender&quot;, &quot;type&quot; : &quot;string&quot;},</span>
<a id=__codelineno-68-13 name=__codelineno-68-13 href=#__codelineno-68-13></a><span class=s1>                {&quot;name&quot; : &quot;place_of_birth&quot;,&quot;type&quot; : &quot;string&quot;,&quot;default&quot;: &quot;nonDefined&quot;}]}&#39;</span>
<a id=__codelineno-68-14 name=__codelineno-68-14 href=#__codelineno-68-14></a>
<a id=__codelineno-68-15 name=__codelineno-68-15 href=#__codelineno-68-15></a><span class=o>{</span><span class=s2>&quot;id&quot;</span>:<span class=s2>&quot;demo-schema&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;AVRO&quot;</span>,<span class=s2>&quot;version&quot;</span>:2,<span class=s2>&quot;createdBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;createdOn&quot;</span>:1589553367867,<span class=s2>&quot;modifiedBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;modifiedOn&quot;</span>:1589556982143,<span class=s2>&quot;globalId&quot;</span>:27<span class=o>}</span>
</code></pre></div> <p>Effectively, we have just evolved our Avro data <code>demo-schema</code> schema to include a new attribute called <code>place_of_birth</code>.</p> <p>Now, how about if we wanted to delete an attribute in our schema? Let's try to remove the <code>gender</code> attribute:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-69-1 name=__codelineno-69-1 href=#__codelineno-69-1></a>$ curl  -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=se>\</span>
<a id=__codelineno-69-2 name=__codelineno-69-2 href=#__codelineno-69-2></a>        -H <span class=s1>&#39;Content-Type: application/json&#39;</span> <span class=se>\</span>
<a id=__codelineno-69-3 name=__codelineno-69-3 href=#__codelineno-69-3></a>        -H <span class=s1>&#39;X-Registry-ArtifactId: demo-schema&#39;</span> <span class=se>\</span>
<a id=__codelineno-69-4 name=__codelineno-69-4 href=#__codelineno-69-4></a>        <span class=nv>$URL</span>/artifacts/demo-schema/versions <span class=se>\</span>
<a id=__codelineno-69-5 name=__codelineno-69-5 href=#__codelineno-69-5></a>        -d <span class=s1>&#39;{</span>
<a id=__codelineno-69-6 name=__codelineno-69-6 href=#__codelineno-69-6></a><span class=s1>            &quot;namespace&quot;: &quot;schema.compatibility.test&quot;,</span>
<a id=__codelineno-69-7 name=__codelineno-69-7 href=#__codelineno-69-7></a><span class=s1>            &quot;name&quot;: &quot;person&quot;,</span>
<a id=__codelineno-69-8 name=__codelineno-69-8 href=#__codelineno-69-8></a><span class=s1>            &quot;type&quot;: &quot;record&quot;,</span>
<a id=__codelineno-69-9 name=__codelineno-69-9 href=#__codelineno-69-9></a><span class=s1>            &quot;fields&quot; : [</span>
<a id=__codelineno-69-10 name=__codelineno-69-10 href=#__codelineno-69-10></a><span class=s1>                {&quot;name&quot; : &quot;name&quot;, &quot;type&quot; : &quot;string&quot;},</span>
<a id=__codelineno-69-11 name=__codelineno-69-11 href=#__codelineno-69-11></a><span class=s1>                {&quot;name&quot; : &quot;age&quot;, &quot;type&quot; : &quot;int&quot;},</span>
<a id=__codelineno-69-12 name=__codelineno-69-12 href=#__codelineno-69-12></a><span class=s1>                {&quot;name&quot; : &quot;place_of_birth&quot;,&quot;type&quot; : &quot;string&quot;,&quot;default&quot;: &quot;nonDefined&quot;}]}&#39;</span>
<a id=__codelineno-69-13 name=__codelineno-69-13 href=#__codelineno-69-13></a>
<a id=__codelineno-69-14 name=__codelineno-69-14 href=#__codelineno-69-14></a><span class=o>{</span><span class=s2>&quot;id&quot;</span>:<span class=s2>&quot;demo-schema&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;AVRO&quot;</span>,<span class=s2>&quot;version&quot;</span>:3,<span class=s2>&quot;createdBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;createdOn&quot;</span>:1589553367867,<span class=s2>&quot;modifiedBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;modifiedOn&quot;</span>:1589557152931,<span class=s2>&quot;globalId&quot;</span>:28<span class=o>}</span>
</code></pre></div> <p>It worked. The resaon for this is that the consumer reading messages with the newer schema that does not contain the <code>gender</code> attribute, will simply ignore/drop all those attributes in the old person events/messages that are not defined in the newer data schema and just take in those that are defined. In this case, if it reads messages produced with the older data schema that come with the <code>gender</code> attribute, it will simply drop it.</p> <h3 id=forward>Forward<a class=headerlink href=#forward title="Permanent link">&para;</a></h3> <p>First of all, set the compatibility mode to forward at the global level (for simplicity):</p> <div class=highlight><pre><span></span><code><a id=__codelineno-70-1 name=__codelineno-70-1 href=#__codelineno-70-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> -X PUT <span class=nv>$URL</span>/rules/COMPATIBILITY -d <span class=s1>&#39;{&quot;type&quot;:&quot;COMPATIBILITY&quot;,&quot;config&quot;:&quot;FORWARD&quot;}&#39;</span>
<a id=__codelineno-70-2 name=__codelineno-70-2 href=#__codelineno-70-2></a>
<a id=__codelineno-70-3 name=__codelineno-70-3 href=#__codelineno-70-3></a><span class=o>{</span><span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;COMPATIBILITY&quot;</span>,<span class=s2>&quot;config&quot;</span>:<span class=s2>&quot;FORWARD&quot;</span><span class=o>}</span>
</code></pre></div> <p>Now, how about removing an attribute when the compatibility type configured is set to FORWARD? Let's try to remove the <code>age</code> attribute:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-71-1 name=__codelineno-71-1 href=#__codelineno-71-1></a>$ curl  -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=se>\</span>
<a id=__codelineno-71-2 name=__codelineno-71-2 href=#__codelineno-71-2></a>        -H <span class=s1>&#39;Content-Type: application/json&#39;</span> <span class=se>\</span>
<a id=__codelineno-71-3 name=__codelineno-71-3 href=#__codelineno-71-3></a>        -H <span class=s1>&#39;X-Registry-ArtifactId: demo-schema&#39;</span> <span class=se>\</span>
<a id=__codelineno-71-4 name=__codelineno-71-4 href=#__codelineno-71-4></a>        <span class=nv>$URL</span>/artifacts/demo-schema/versions <span class=se>\</span>
<a id=__codelineno-71-5 name=__codelineno-71-5 href=#__codelineno-71-5></a>        -d <span class=s1>&#39;{</span>
<a id=__codelineno-71-6 name=__codelineno-71-6 href=#__codelineno-71-6></a><span class=s1>            &quot;namespace&quot;: &quot;schema.compatibility.test&quot;,</span>
<a id=__codelineno-71-7 name=__codelineno-71-7 href=#__codelineno-71-7></a><span class=s1>            &quot;name&quot;: &quot;person&quot;,</span>
<a id=__codelineno-71-8 name=__codelineno-71-8 href=#__codelineno-71-8></a><span class=s1>            &quot;type&quot;: &quot;record&quot;,</span>
<a id=__codelineno-71-9 name=__codelineno-71-9 href=#__codelineno-71-9></a><span class=s1>            &quot;fields&quot; : [</span>
<a id=__codelineno-71-10 name=__codelineno-71-10 href=#__codelineno-71-10></a><span class=s1>                {&quot;name&quot; : &quot;name&quot;, &quot;type&quot; : &quot;string&quot;},</span>
<a id=__codelineno-71-11 name=__codelineno-71-11 href=#__codelineno-71-11></a><span class=s1>                {&quot;name&quot; : &quot;place_of_birth&quot;,&quot;type&quot; : &quot;string&quot;,&quot;default&quot;: &quot;nonDefined&quot;}]}&#39;</span>
<a id=__codelineno-71-12 name=__codelineno-71-12 href=#__codelineno-71-12></a>
<a id=__codelineno-71-13 name=__codelineno-71-13 href=#__codelineno-71-13></a><span class=o>{</span><span class=s2>&quot;error_code&quot;</span>:409,<span class=s2>&quot;message&quot;</span>:<span class=s2>&quot;Schema failed compatibility check with version ID: demo-schema, schema not forward compatible: reader&#39;s &#39;record&#39; schema named &#39;schema.compatibility.test.person&#39; contains a field named &#39;age&#39; that does not match any field in the corresponding writer&#39;s schema. The reader&#39;s schema does not specify a default value for this field&quot;</span><span class=o>}</span>
</code></pre></div> <p>As the error above explains, the problem we have when we want to remove an attribute from our Avro data schema with the compatibility mode set to <code>forward</code> is that the producer will be sending messages without the removed attribute (<code>age</code> in our case) while the consumer will be reading messages with the older Avro data schema that expects such attribute, which is what the forward compatibility required: forward compatibility means that <strong>data produced with a new schema can be read by consumers using the last schema</strong>.</p> <p>What can we do to have a schema that allows the producer to send messages that do not contain an attribute that the consumer expects?</p> <p>The trick here is to first <strong>register an "intermediate" data schema that adds a default value</strong> to the attibute we want to remove from the schema (<code>age</code> in our case). This way, the "intermediate" data schema will become the older data schema for the consumers so when we register the new schema without the attribute we wanted to remove and produce data according to it (that is, without the <code>age</code> attribute) afterwards, the consumers will not complain since they will have in the schema they use (the "intermediate" schema) a default value for that attribute. And they will use that default value when reading messages without the <code>age</code> attribute.</p> <p>That is, our intermediate schema will be:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-72-1 name=__codelineno-72-1 href=#__codelineno-72-1></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-72-2 name=__codelineno-72-2 href=#__codelineno-72-2></a><span class=w>    </span><span class=nt>&quot;namespace&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;schema.compatibility.test&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-72-3 name=__codelineno-72-3 href=#__codelineno-72-3></a><span class=w>    </span><span class=nt>&quot;name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;person&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-72-4 name=__codelineno-72-4 href=#__codelineno-72-4></a><span class=w>    </span><span class=nt>&quot;type&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;record&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-72-5 name=__codelineno-72-5 href=#__codelineno-72-5></a><span class=w>    </span><span class=nt>&quot;fields&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w></span>
<a id=__codelineno-72-6 name=__codelineno-72-6 href=#__codelineno-72-6></a><span class=w>        </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-72-7 name=__codelineno-72-7 href=#__codelineno-72-7></a><span class=w>            </span><span class=nt>&quot;name&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;name&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-72-8 name=__codelineno-72-8 href=#__codelineno-72-8></a><span class=w>            </span><span class=nt>&quot;type&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;string&quot;</span><span class=w></span>
<a id=__codelineno-72-9 name=__codelineno-72-9 href=#__codelineno-72-9></a><span class=w>        </span><span class=p>},</span><span class=w></span>
<a id=__codelineno-72-10 name=__codelineno-72-10 href=#__codelineno-72-10></a><span class=w>        </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-72-11 name=__codelineno-72-11 href=#__codelineno-72-11></a><span class=w>            </span><span class=nt>&quot;name&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;age&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-72-12 name=__codelineno-72-12 href=#__codelineno-72-12></a><span class=w>            </span><span class=nt>&quot;type&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;int&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-72-13 name=__codelineno-72-13 href=#__codelineno-72-13></a><span class=w>            </span><span class=nt>&quot;default&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-72-14 name=__codelineno-72-14 href=#__codelineno-72-14></a><span class=w>        </span><span class=p>},</span><span class=w></span>
<a id=__codelineno-72-15 name=__codelineno-72-15 href=#__codelineno-72-15></a><span class=w>        </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-72-16 name=__codelineno-72-16 href=#__codelineno-72-16></a><span class=w>            </span><span class=nt>&quot;name&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;place_of_birth&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-72-17 name=__codelineno-72-17 href=#__codelineno-72-17></a><span class=w>            </span><span class=nt>&quot;type&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;string&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-72-18 name=__codelineno-72-18 href=#__codelineno-72-18></a><span class=w>            </span><span class=nt>&quot;default&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;nonDefined&quot;</span><span class=w></span>
<a id=__codelineno-72-19 name=__codelineno-72-19 href=#__codelineno-72-19></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-72-20 name=__codelineno-72-20 href=#__codelineno-72-20></a><span class=w>    </span><span class=p>]</span><span class=w></span>
<a id=__codelineno-72-21 name=__codelineno-72-21 href=#__codelineno-72-21></a><span class=p>}</span><span class=w></span>
</code></pre></div> <p>If we try to register that new version of our <code>demo-schema</code> schema:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-73-1 name=__codelineno-73-1 href=#__codelineno-73-1></a>$ curl  -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=se>\</span>
<a id=__codelineno-73-2 name=__codelineno-73-2 href=#__codelineno-73-2></a>        -H <span class=s1>&#39;Content-Type: application/json&#39;</span> <span class=se>\</span>
<a id=__codelineno-73-3 name=__codelineno-73-3 href=#__codelineno-73-3></a>        -H <span class=s1>&#39;X-Registry-ArtifactId: demo-schema&#39;</span> <span class=se>\</span>
<a id=__codelineno-73-4 name=__codelineno-73-4 href=#__codelineno-73-4></a>        <span class=nv>$URL</span>/artifacts/demo-schema/versions <span class=se>\</span>
<a id=__codelineno-73-5 name=__codelineno-73-5 href=#__codelineno-73-5></a>        -d <span class=s1>&#39;{</span>
<a id=__codelineno-73-6 name=__codelineno-73-6 href=#__codelineno-73-6></a><span class=s1>            &quot;namespace&quot;: &quot;schema.compatibility.test&quot;,</span>
<a id=__codelineno-73-7 name=__codelineno-73-7 href=#__codelineno-73-7></a><span class=s1>            &quot;name&quot;: &quot;person&quot;,</span>
<a id=__codelineno-73-8 name=__codelineno-73-8 href=#__codelineno-73-8></a><span class=s1>            &quot;type&quot;: &quot;record&quot;,</span>
<a id=__codelineno-73-9 name=__codelineno-73-9 href=#__codelineno-73-9></a><span class=s1>            &quot;fields&quot; : [</span>
<a id=__codelineno-73-10 name=__codelineno-73-10 href=#__codelineno-73-10></a><span class=s1>                {&quot;name&quot; : &quot;name&quot;, &quot;type&quot; : &quot;string&quot;},</span>
<a id=__codelineno-73-11 name=__codelineno-73-11 href=#__codelineno-73-11></a><span class=s1>                {&quot;name&quot; : &quot;age&quot;, &quot;type&quot; : &quot;int&quot;, &quot;default&quot;: 0},</span>
<a id=__codelineno-73-12 name=__codelineno-73-12 href=#__codelineno-73-12></a><span class=s1>                {&quot;name&quot; : &quot;place_of_birth&quot;,&quot;type&quot; : &quot;string&quot;, &quot;default&quot;: &quot;nonDefined&quot;}]}&#39;</span>
<a id=__codelineno-73-13 name=__codelineno-73-13 href=#__codelineno-73-13></a>
<a id=__codelineno-73-14 name=__codelineno-73-14 href=#__codelineno-73-14></a><span class=o>{</span><span class=s2>&quot;id&quot;</span>:<span class=s2>&quot;demo-schema&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;AVRO&quot;</span>,<span class=s2>&quot;version&quot;</span>:4,<span class=s2>&quot;createdBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;createdOn&quot;</span>:1589553367867,<span class=s2>&quot;modifiedBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;modifiedOn&quot;</span>:1589560847136,<span class=s2>&quot;globalId&quot;</span>:30<span class=o>}</span>
</code></pre></div> <p>we see we succeed since we are simply adding a default value for the newer schema. This intermediate schema, will become now the older schema at the consumer side but will still be forward compatible with the newer schema at the producer side because it now has a default value for <code>age</code>. Let's try now to add a new version of our <code>demo-schema</code> schema without the <code>age</code> attribute:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-74-1 name=__codelineno-74-1 href=#__codelineno-74-1></a>$ curl  -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=se>\</span>
<a id=__codelineno-74-2 name=__codelineno-74-2 href=#__codelineno-74-2></a>        -H <span class=s1>&#39;Content-Type: application/json&#39;</span> <span class=se>\</span>
<a id=__codelineno-74-3 name=__codelineno-74-3 href=#__codelineno-74-3></a>        -H <span class=s1>&#39;X-Registry-ArtifactId: demo-schema&#39;</span> <span class=se>\</span>
<a id=__codelineno-74-4 name=__codelineno-74-4 href=#__codelineno-74-4></a>        <span class=nv>$URL</span>/artifacts/demo-schema/versions <span class=se>\</span>
<a id=__codelineno-74-5 name=__codelineno-74-5 href=#__codelineno-74-5></a>        -d <span class=s1>&#39;{</span>
<a id=__codelineno-74-6 name=__codelineno-74-6 href=#__codelineno-74-6></a><span class=s1>            &quot;namespace&quot;: &quot;schema.compatibility.test&quot;,</span>
<a id=__codelineno-74-7 name=__codelineno-74-7 href=#__codelineno-74-7></a><span class=s1>            &quot;name&quot;: &quot;person&quot;,</span>
<a id=__codelineno-74-8 name=__codelineno-74-8 href=#__codelineno-74-8></a><span class=s1>            &quot;type&quot;: &quot;record&quot;,</span>
<a id=__codelineno-74-9 name=__codelineno-74-9 href=#__codelineno-74-9></a><span class=s1>            &quot;fields&quot; : [</span>
<a id=__codelineno-74-10 name=__codelineno-74-10 href=#__codelineno-74-10></a><span class=s1>                {&quot;name&quot; : &quot;name&quot;, &quot;type&quot; : &quot;string&quot;},</span>
<a id=__codelineno-74-11 name=__codelineno-74-11 href=#__codelineno-74-11></a><span class=s1>                {&quot;name&quot; : &quot;place_of_birth&quot;,&quot;type&quot; : &quot;string&quot;, &quot;default&quot;: &quot;nonDefined&quot;}]}&#39;</span>
<a id=__codelineno-74-12 name=__codelineno-74-12 href=#__codelineno-74-12></a>
<a id=__codelineno-74-13 name=__codelineno-74-13 href=#__codelineno-74-13></a><span class=o>{</span><span class=s2>&quot;id&quot;</span>:<span class=s2>&quot;demo-schema&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;AVRO&quot;</span>,<span class=s2>&quot;version&quot;</span>:5,<span class=s2>&quot;createdBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;createdOn&quot;</span>:1589553367867,<span class=s2>&quot;modifiedBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;modifiedOn&quot;</span>:1589561057270,<span class=s2>&quot;globalId&quot;</span>:31<span class=o>}</span>
</code></pre></div> <p>tada! we succeeded. As we said, the older schema now at the consumer side has a default value for <code>age</code> so the new messages produced with the newer schema coming without the <code>age</code> attribute can be successfully read by the consumer using the default value.</p> <p>How about adding a new attribute when the compatibility mode is set to forward? Let's try to add the attribute <code>siblings</code> to denote the number of borthers and sisters a person might have:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-75-1 name=__codelineno-75-1 href=#__codelineno-75-1></a>$ curl  -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=se>\</span>
<a id=__codelineno-75-2 name=__codelineno-75-2 href=#__codelineno-75-2></a>        -H <span class=s1>&#39;Content-Type: application/json&#39;</span> <span class=se>\</span>
<a id=__codelineno-75-3 name=__codelineno-75-3 href=#__codelineno-75-3></a>        -H <span class=s1>&#39;X-Registry-ArtifactId: demo-schema&#39;</span> <span class=se>\</span>
<a id=__codelineno-75-4 name=__codelineno-75-4 href=#__codelineno-75-4></a>        <span class=nv>$URL</span>/artifacts/demo-schema/versions <span class=se>\</span>
<a id=__codelineno-75-5 name=__codelineno-75-5 href=#__codelineno-75-5></a>        -d <span class=s1>&#39;{</span>
<a id=__codelineno-75-6 name=__codelineno-75-6 href=#__codelineno-75-6></a><span class=s1>            &quot;namespace&quot;: &quot;schema.compatibility.test&quot;,</span>
<a id=__codelineno-75-7 name=__codelineno-75-7 href=#__codelineno-75-7></a><span class=s1>            &quot;name&quot;: &quot;person&quot;,</span>
<a id=__codelineno-75-8 name=__codelineno-75-8 href=#__codelineno-75-8></a><span class=s1>            &quot;type&quot;: &quot;record&quot;,</span>
<a id=__codelineno-75-9 name=__codelineno-75-9 href=#__codelineno-75-9></a><span class=s1>            &quot;fields&quot; : [</span>
<a id=__codelineno-75-10 name=__codelineno-75-10 href=#__codelineno-75-10></a><span class=s1>                {&quot;name&quot; : &quot;name&quot;, &quot;type&quot; : &quot;string&quot;},</span>
<a id=__codelineno-75-11 name=__codelineno-75-11 href=#__codelineno-75-11></a><span class=s1>                {&quot;name&quot; : &quot;place_of_birth&quot;,&quot;type&quot; : &quot;string&quot;, &quot;default&quot;: &quot;nonDefined&quot;},</span>
<a id=__codelineno-75-12 name=__codelineno-75-12 href=#__codelineno-75-12></a><span class=s1>                {&quot;name&quot; : &quot;siblings&quot;, &quot;type&quot; : &quot;int&quot;}]}&#39;</span>
<a id=__codelineno-75-13 name=__codelineno-75-13 href=#__codelineno-75-13></a>
<a id=__codelineno-75-14 name=__codelineno-75-14 href=#__codelineno-75-14></a><span class=o>{</span><span class=s2>&quot;id&quot;</span>:<span class=s2>&quot;demo-schema&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;AVRO&quot;</span>,<span class=s2>&quot;version&quot;</span>:6,<span class=s2>&quot;createdBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;createdOn&quot;</span>:1589553367867,<span class=s2>&quot;modifiedBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;modifiedOn&quot;</span>:1589561302428,<span class=s2>&quot;globalId&quot;</span>:32<span class=o>}</span>
</code></pre></div> <p>Contrary to what happened when addign a new attribute to an Avro data schema when the compatibility mode is set to backward, adding an attribute to an Avro data schema when the compatibility mode is set to forward is not a problem because the new attributes coming with the messages that the consumer does not expect based on the older Avro data schema it uses will simply get dropped/skipped.</p> <h3 id=full>Full<a class=headerlink href=#full title="Permanent link">&para;</a></h3> <p>First of all, set the compatibility mode to full at the global level (for simplicity):</p> <div class=highlight><pre><span></span><code><a id=__codelineno-76-1 name=__codelineno-76-1 href=#__codelineno-76-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> -X PUT <span class=nv>$URL</span>/rules/COMPATIBILITY -d <span class=s1>&#39;{&quot;type&quot;:&quot;COMPATIBILITY&quot;,&quot;config&quot;:&quot;FULL&quot;}&#39;</span>
<a id=__codelineno-76-2 name=__codelineno-76-2 href=#__codelineno-76-2></a>
<a id=__codelineno-76-3 name=__codelineno-76-3 href=#__codelineno-76-3></a><span class=o>{</span><span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;COMPATIBILITY&quot;</span>,<span class=s2>&quot;config&quot;</span>:<span class=s2>&quot;FULL&quot;</span><span class=o>}</span>
</code></pre></div> <p>Full compatibility means <strong>data schemas are both backward and forward compatible</strong>. Data schemas evolve in a fully compatible way: <strong>old data can be read with the new data schema, and new data can also be read with the last data schema</strong>.</p> <p>In some data formats, such as JSON, there are no full-compatible changes. Every modification is either only forward or only backward compatible. But in other data formats, like Avro, you can define fields with default values. In that case adding or removing a field with a default value is a fully compatible change.</p> <p>So let's see if we can delete the <code>place_of_birth</code> attribute (the only attribute in our data schema that defines a default value):</p> <div class=highlight><pre><span></span><code><a id=__codelineno-77-1 name=__codelineno-77-1 href=#__codelineno-77-1></a>$ curl  -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=se>\</span>
<a id=__codelineno-77-2 name=__codelineno-77-2 href=#__codelineno-77-2></a>        -H <span class=s1>&#39;Content-Type: application/json&#39;</span> <span class=se>\</span>
<a id=__codelineno-77-3 name=__codelineno-77-3 href=#__codelineno-77-3></a>        -H <span class=s1>&#39;X-Registry-ArtifactId: demo-schema&#39;</span> <span class=se>\</span>
<a id=__codelineno-77-4 name=__codelineno-77-4 href=#__codelineno-77-4></a>        <span class=nv>$URL</span>/artifacts/demo-schema/versions <span class=se>\</span>
<a id=__codelineno-77-5 name=__codelineno-77-5 href=#__codelineno-77-5></a>        -d <span class=s1>&#39;{</span>
<a id=__codelineno-77-6 name=__codelineno-77-6 href=#__codelineno-77-6></a><span class=s1>            &quot;namespace&quot;: &quot;schema.compatibility.test&quot;,</span>
<a id=__codelineno-77-7 name=__codelineno-77-7 href=#__codelineno-77-7></a><span class=s1>            &quot;name&quot;: &quot;person&quot;,</span>
<a id=__codelineno-77-8 name=__codelineno-77-8 href=#__codelineno-77-8></a><span class=s1>            &quot;type&quot;: &quot;record&quot;,</span>
<a id=__codelineno-77-9 name=__codelineno-77-9 href=#__codelineno-77-9></a><span class=s1>            &quot;fields&quot; : [</span>
<a id=__codelineno-77-10 name=__codelineno-77-10 href=#__codelineno-77-10></a><span class=s1>                {&quot;name&quot; : &quot;name&quot;, &quot;type&quot; : &quot;string&quot;},</span>
<a id=__codelineno-77-11 name=__codelineno-77-11 href=#__codelineno-77-11></a><span class=s1>                {&quot;name&quot; : &quot;siblings&quot;, &quot;type&quot; : &quot;int&quot;}]}&#39;</span>
<a id=__codelineno-77-12 name=__codelineno-77-12 href=#__codelineno-77-12></a>
<a id=__codelineno-77-13 name=__codelineno-77-13 href=#__codelineno-77-13></a><span class=o>{</span><span class=s2>&quot;id&quot;</span>:<span class=s2>&quot;demo-schema&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;AVRO&quot;</span>,<span class=s2>&quot;version&quot;</span>:7,<span class=s2>&quot;createdBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;createdOn&quot;</span>:1589553367867,<span class=s2>&quot;modifiedBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;modifiedOn&quot;</span>:1589562453126,<span class=s2>&quot;globalId&quot;</span>:33<span class=o>}</span>
</code></pre></div> <p>It seems it works. But how about removing an attribute that does not have a default value? Well, we need to do the trick of the "intermediate" schema again where we first add a default for that attribute and register the schema to later register a newer schema where we remove that attibute.</p> <p>Let's see adding a new attribute called <code>height</code> (remember we need to add a default value for it because of the full compatibility mode):</p> <div class=highlight><pre><span></span><code><a id=__codelineno-78-1 name=__codelineno-78-1 href=#__codelineno-78-1></a>$ curl  -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=se>\</span>
<a id=__codelineno-78-2 name=__codelineno-78-2 href=#__codelineno-78-2></a>        -H <span class=s1>&#39;Content-Type: application/json&#39;</span> <span class=se>\</span>
<a id=__codelineno-78-3 name=__codelineno-78-3 href=#__codelineno-78-3></a>        -H <span class=s1>&#39;X-Registry-ArtifactId: demo-schema&#39;</span> <span class=se>\</span>
<a id=__codelineno-78-4 name=__codelineno-78-4 href=#__codelineno-78-4></a>        <span class=nv>$URL</span>/artifacts/demo-schema/versions <span class=se>\</span>
<a id=__codelineno-78-5 name=__codelineno-78-5 href=#__codelineno-78-5></a>        -d <span class=s1>&#39;{</span>
<a id=__codelineno-78-6 name=__codelineno-78-6 href=#__codelineno-78-6></a><span class=s1>            &quot;namespace&quot;: &quot;schema.compatibility.test&quot;,</span>
<a id=__codelineno-78-7 name=__codelineno-78-7 href=#__codelineno-78-7></a><span class=s1>            &quot;name&quot;: &quot;person&quot;,</span>
<a id=__codelineno-78-8 name=__codelineno-78-8 href=#__codelineno-78-8></a><span class=s1>            &quot;type&quot;: &quot;record&quot;,</span>
<a id=__codelineno-78-9 name=__codelineno-78-9 href=#__codelineno-78-9></a><span class=s1>            &quot;fields&quot; : [</span>
<a id=__codelineno-78-10 name=__codelineno-78-10 href=#__codelineno-78-10></a><span class=s1>                {&quot;name&quot; : &quot;name&quot;, &quot;type&quot; : &quot;string&quot;},</span>
<a id=__codelineno-78-11 name=__codelineno-78-11 href=#__codelineno-78-11></a><span class=s1>                {&quot;name&quot; : &quot;siblings&quot;, &quot;type&quot; : &quot;int&quot;},</span>
<a id=__codelineno-78-12 name=__codelineno-78-12 href=#__codelineno-78-12></a><span class=s1>                {&quot;name&quot; : &quot;height&quot;, &quot;type&quot; : &quot;int&quot;, &quot;default&quot;: 0}]}&#39;</span>
<a id=__codelineno-78-13 name=__codelineno-78-13 href=#__codelineno-78-13></a>
<a id=__codelineno-78-14 name=__codelineno-78-14 href=#__codelineno-78-14></a><span class=o>{</span><span class=s2>&quot;id&quot;</span>:<span class=s2>&quot;demo-schema&quot;</span>,<span class=s2>&quot;type&quot;</span>:<span class=s2>&quot;AVRO&quot;</span>,<span class=s2>&quot;version&quot;</span>:8,<span class=s2>&quot;createdBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;createdOn&quot;</span>:1589553367867,<span class=s2>&quot;modifiedBy&quot;</span>:<span class=s2>&quot;&quot;</span>,<span class=s2>&quot;modifiedOn&quot;</span>:1589562591316,<span class=s2>&quot;globalId&quot;</span>:34<span class=o>}</span>
</code></pre></div> <p>We see it also works. Now we know how a data schema can evolve when full compatibility is required.</p> <p>As a final exercise, check how many times we have evolve our <code>demo-schema</code> schema for the compatibility rules:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-79-1 name=__codelineno-79-1 href=#__codelineno-79-1></a>$ curl -u token:<span class=nv>$KAFKA_APIKEY</span> <span class=nv>$URL</span>/artifacts/demo-schema/versions
<a id=__codelineno-79-2 name=__codelineno-79-2 href=#__codelineno-79-2></a>
<a id=__codelineno-79-3 name=__codelineno-79-3 href=#__codelineno-79-3></a><span class=o>[</span><span class=m>1</span>,2,3,4,5,6,7,8<span class=o>]</span>
</code></pre></div> <h2 id=security>Security<a class=headerlink href=#security title="Permanent link">&para;</a></h2> <p>As we have already mentioned during the this tutorial, we need to pay attention to the permissions we give to users, groups, applications (and thefore the clients they used to interact with IBM Event Streams on IBM Cloud), etc since we dont want everyone and everything to be, for instance, creating or deleting schemas or updating the compatibility modes for schema evolution.</p> <p>As a result, the IBM Event Streams on IBM Cloud schema registry introduces a new IAM resource type: <strong>schema</strong>. This can be used as part of a CRN to identify a particular schema. For example:</p> <ul> <li> <p>A CRN that names a specific schema (test-schema), for a particular instance of an Event Streams service:</p> <p><code>crn:v1:bluemix:public:messagehub:us-south:a/6db1b0d0b5c54ee5c201552547febcd8:91191e31-5642-4f2d-936f-647332dce3ae:schema:test-schema</code></p> </li> <li> <p>A CRN that describes all of the schemas for a particular instance of the Event Streams service:</p> <p><code>crn:v1:bluemix:public:messagehub:us-south:a/6db1b0d0b5c54ee5c201552547febcd8:91191e31-5642-4f2d-936f-647332dce3ae:schema:</code></p> </li> <li> <p>While not directly related to the addition of the schema resource type, it is also worth noting that it is possible to apply policies to a CRN describing a particular Event Streams instance. For example, policies granted at the scope of this CRN would affect all resources (topics, schemas, etc.) belonging to the cluster:</p> <p><code>crn:v1:bluemix:public:messagehub:us-south:a/6db1b0d0b5c54ee5c201552547febcd8:91191e31-5642-4f2d-936f-647332dce3ae::</code></p> </li> </ul> <p>With the addition of the new schema IAM resource type it is possible to create policies that control access using varying degrees of granularity, for example:</p> <ul> <li>a specific schema</li> <li>a set of schemas selected via a wildcard expression</li> <li>all of the schemas stored by an instance of IBM Event Streams</li> <li>all of the schemas stored by all of the instances of IBM Event Streams in an account</li> </ul> <p>Please, review the security documentation you can find <a href=/technology/event-streams/security/ >here</a> in order to understand how to create the policies for assigning specific permissions at the differentt levels of a cloud resource (that is, at the level of any Event Streams, a specific Event Streams instance but all topics, etc).</p> <h3 id=schema-security-role-mapping>Schema security role mapping<a class=headerlink href=#schema-security-role-mapping title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>Action</th> <th>Event Streams cluster resource</th> <th>Schema resource</th> </tr> </thead> <tbody> <tr> <td>Create schema</td> <td>Read</td> <td>Write</td> </tr> <tr> <td>List schemas</td> <td>Read</td> <td>Read</td> </tr> <tr> <td>Delete schema</td> <td>Read</td> <td>Manager</td> </tr> <tr> <td>Create schema version</td> <td>Read</td> <td>Write</td> </tr> <tr> <td>Get latest schema version</td> <td>Read</td> <td>Read</td> </tr> <tr> <td>Get specific schema version</td> <td>Read</td> <td>Read</td> </tr> <tr> <td>List all schema versions</td> <td>Read</td> <td>Read</td> </tr> <tr> <td>Delete a schema version</td> <td>Read</td> <td>Manager</td> </tr> </tbody> </table> <h3 id=compatibilitty-rules-security-role-mapping>Compatibilitty rules security role mapping<a class=headerlink href=#compatibilitty-rules-security-role-mapping title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>Action</th> <th>Event Streams cluster resource</th> <th>Schema resource</th> </tr> </thead> <tbody> <tr> <td>Update global rule</td> <td>Manager</td> <td>-</td> </tr> <tr> <td>Get global rule</td> <td>Read</td> <td>-</td> </tr> <tr> <td>Create per schema rule</td> <td>Read</td> <td>Manager</td> </tr> <tr> <td>Get per schema rule</td> <td>Read</td> <td>Read</td> </tr> <tr> <td>Update per schema rule</td> <td>Read</td> <td>Manager</td> </tr> <tr> <td>Delete per schema rule</td> <td>Read</td> <td>Manager</td> </tr> </tbody> </table> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../kafka-mm2/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Mirror maker 2 labs" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Mirror maker 2 labs </div> </div> </a> <a href=../schema-registry-on-ocp/ class="md-footer__link md-footer__link--next" aria-label="Next: Schema registry" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Schema registry </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright  2022 IBM </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/ibm-cloud-architecture target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://twitter.com/agileitarchitecture target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["content.code.annotate", "content.tooltips", "navigation.instant", "navigation.tabs.sticky", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../assets/javascripts/bundle.9c69f0bc.min.js></script> </body> </html>